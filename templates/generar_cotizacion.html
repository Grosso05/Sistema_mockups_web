<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Costos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_cotizador.css') }}">
    <style>
        
    </style>
</head>
<body>

    <main role="main" class="col-md-10 ml-sm-auto col-lg-10 px-4">
    <section class="flex">
        <div class="seccion-izquierda flex-item">
            <h2> Productos </h2>
            <div class="item-descripcion-container">
                <div class="item-number" id="itemNumber"></div>
                <textarea id="descripcion" name="descripcion" rows="2" class="descripcion-input" placeholder="Ingrese la descripción del producto" required></textarea>
            </div>
            <div class="grupo">
                <label for="seleccionarLinea">Línea:</label>
                <select id="seleccionarLinea" name="seleccionarLinea">
                    <option value="">Seleccionar</option>
                    {% for linea in lineas %}
                        <option value="{{ linea.linea_id }}">{{ linea.nombre }}</option>

                    {% endfor %}
                </select>
            </div>
            <div class="grupo">
                <label for="seleccionarProducto">Producto:</label>
                <select id="seleccionarProducto" name="seleccionarProducto">
                    <option value="">Seleccionar</option>
                </select>
                <label for="alto">Alto:</label>
                <input type="number" id="alto" name="alto" min="10" max="1000" />
                <label for="ancho">Ancho:</label>
                <input type="number" id="ancho" name="ancho" min="10" max="1000" />
                <label for="fondo">Fondo:</label>
                <input type="number" id="fondo" name="fondo" min="10" max="1000" />
            </div>
            <div class="grupo botones">
                <button id="btnCrear">Añadir</button>
            </div>
        </div>
        <div class="seccion-derecha flex-item flex-grow">
            <div class="header-cotizacion">
                <h2>Datos de Cotización</h2>
        <button id="toggleDatosBtn" class="flecha-btn">></button>
    </div>
    <div class="grupo-columns" id="formulario-cotizacion" style="display: none;">
        <div class="grupo-columns" id="formulario-cotizacion">
            <div class="grupo-columna">
                <div class="grupo">
                    <label for="fecha"> Fecha </label>
                    <input type="date" id="fecha" name="fecha" value="" required>
                </div>
                <div class="grupo">
                    <label for="cliente"> Cliente  </label>
                    <input type="text" id="cliente" name="cliente" required>
                </div>
                <div class="grupo">
                    <label for="contacto"> Contacto  </label>
                    <input type="text" id="contacto" name="contacto" required>
                </div>
                <div class="grupo">
                    <label for="proyecto"> Proyecto  </label>
                    <input type="text" id="proyecto" name="proyecto" required>
                </div>
                <div class="grupo">
                    <label for="vendedor"> Vendedor </label>
                    <select id="vendedor" name="vendedor" required>
                        <option value="">Seleccionar</option>
                        {% for vendedor in vendedores %}
                        <option value="{{ vendedor.user_id }}">{{ vendedor.user_name }} {{ vendedor.user_last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="grupo">
                    <label for="negociacion"> N° Negociacion </label>
                    <input type="text" id="negociacion" name=" negociacion " required>
                </div>
            </div>
            <div class="grupo-columna">
                <div class="grupo">
                    <label for="formaPago"> Forma de Pago  </label>
                    <select id="formaPago" name="formaPago" required>
                        <option value="">Seleccionar</option>
                        <option value="Contado" selected>Contado</option>
                        <option value="Credito 30 Dias">Crédito 30 Días</option>
                        <option value="Credito 60 Dias">Crédito 60 Días</option>
                        <option value="50% abono - 50% entrega">50% Abono - 50% Entrega</option>
                    </select>
                </div>
                <div class="grupo">
                    <label for="validez"> Validez  </label>
                    <select id="validez" name="validez" required>
                        <option value="15">15 días</option>
                        <option value="30" selected>30 días</option>
                        <option value="60">60 días</option>
                    </select>
                </div>
                <div class="grupo">
                    <label for="descuento"> Porcentaje Descuento </label>
                    <input type="number" id="descuento" name="descuento" min="0" max="100" required>
                </div>
                <div class="grupo">
                    <label for="personaRecibe"> Persona que Recibe  </label>
                    <input type="text" id="personaRecibe" name="personaRecibe" required>
                </div>
                <div class="grupo">
                    <label for="numeroContacto"> Número de Contacto </label>
                    <input type="tel" id="numeroContacto" name="numeroContacto" required>
                </div>
                <div class="grupo">
                    <label for="direccion"> Dirección  </label>
                    <textarea id="direccion" name="direccion" rows="3" required></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div id="productos-cotizacion" class="productos-cotizacion">
        <h2>Productos de la Cotización</h2>
        <div id="notification-container" class="notification-container"></div>

        <div id="productos-container"></div>
    </div>

</main>

<script>

    // Obtener la fecha actual en formato YYYY-MM-DD
    const today = new Date().toISOString().slice(0, 10);

    // Establecer la fecha actual como valor por defecto
    document.getElementById('fecha').value = today;

    // Función para contraer el formulario de los datos de cotizacion

    document.getElementById('toggleDatosBtn').addEventListener('click', function() {
        const formularioCotizacion = document.getElementById('formulario-cotizacion');
        formularioCotizacion.style.display = formularioCotizacion.style.display === 'none' ? 'flex' : 'none';
        this.textContent = formularioCotizacion.style.display === 'none' ? '>' : 'v';
        this.classList.toggle('expandido');
    });


    document.getElementById('seleccionarLinea').addEventListener('change', function() {
        const lineaId = this.value;
        const productoSelect = document.getElementById('seleccionarProducto');
        productoSelect.innerHTML = '<option value="">Seleccionar</option>'; // Clear current options

        fetch(`/productos_por_linea/${lineaId}`)
            .then(response => response.json())
            .then(productos => {
                productos.forEach(producto => {
                    const option = document.createElement('option');
                    option.value = producto.id;
                    option.textContent = producto.nombre;
                    productoSelect.appendChild(option);
                });
            });
    });

    let itemNumber = 0;
    let numerosEliminados = [];
    let temporalItemID = 1; // ID inicial para ítems temporales, será decreciente

    
    document.getElementById('btnCrear').addEventListener('click', function() {
        const descripcionInput = document.getElementById('descripcion');
        const productoSelect = document.getElementById('seleccionarProducto');
        const descripcion = descripcionInput.value.trim();
        const productoId = productoSelect.value;
        const productoNombre = productoSelect.options[productoSelect.selectedIndex].text;
    
        if (descripcion === "" || productoId === "") {
            alert("Por favor, ingrese una descripción y seleccione un producto.");
            return;
        }
    
        let nuevoNumeroProducto;
    
        if (numerosEliminados.length > 0) {
            nuevoNumeroProducto = numerosEliminados.shift(); // Reutilizar el número más bajo disponible
        } else {
            nuevoNumeroProducto = ++itemNumber; // Incrementar el número de producto
        }
    
        const productosContainer = document.getElementById('productos-container');
    
        // Crear el nuevo producto
        const nuevoProducto = document.createElement('div');
        nuevoProducto.className = 'producto';
        nuevoProducto.id = `producto-${nuevoNumeroProducto}`;
    
        // Crear el contenido del nuevo producto
        nuevoProducto.innerHTML = `
            <h3>Producto ${nuevoNumeroProducto}: ${productoNombre}</h3>
            <h4>Descripción: ${descripcion}</h4>
            <div class="itemsseleccionados">
                <h4>Items Seleccionados</h4>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Grupo</th>
                            <th>Descripción</th>
                            <th>Unidad</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th class="oculto">Tipo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="itemsseleccionados-${nuevoNumeroProducto}">
                        <tbody id="materiaprima-${nuevoNumeroProducto}"></tbody>
                        <tbody id="consumibles-${nuevoNumeroProducto}"></tbody>
                        <tbody id="servicios-${nuevoNumeroProducto}"></tbody>
                        <tbody id="manodeobra-${nuevoNumeroProducto}"></tbody>
                        <tbody id="transporte-${nuevoNumeroProducto}"></tbody>
                    </tbody>
                </table>
            </div>
            <div id="seleccion-items-container-${nuevoNumeroProducto}" style="display: none;">
                <div>
                    <h4>Seleccionar Ítems</h4>
                    <input type="text" id="buscar-item-${nuevoNumeroProducto}" placeholder="Buscar ítems">
                    <div id="seleccion-items-${nuevoNumeroProducto}"></div>
                    <div id="paginacion-items-${nuevoNumeroProducto}"></div>
                    <div class="botones-container">
                        <button onclick="agregarItemsSeleccionados(${nuevoNumeroProducto})">Agregar Ítems Seleccionados</button>
                        <button onclick="verTodosItems(${nuevoNumeroProducto}, 1, '')">Ver Todos los Ítems</button>
                    </div>
                </div>
            </div>

            <!-- Formulario para agregar ítems temporales -->
        <div class="form-agregar-item-manual" data-producto-id="${nuevoNumeroProducto}">
            <h4>Agregar Nuevo Ítem</h4>
            <input type="text" id="nuevo-item-descripcion-${nuevoNumeroProducto}" placeholder="Descripción del Ítem">
            <input type="number" id="nuevo-item-precio-${nuevoNumeroProducto}" placeholder="Precio del Ítem">
            <input type="number" id="nuevo-item-cantidad-${nuevoNumeroProducto}" placeholder="Cantidad del Ítem" value="1" min="1">
            <button id="btnAgregarItemManual-${nuevoNumeroProducto}" onclick="agregarItemTemporal(${nuevoNumeroProducto})">Agregar Ítem</button>
        </div>



    <div id="resultado" class="resultado">
        <h2>Resumen De Costos Producto ${nuevoNumeroProducto}</h2>
        <p id="costo-directo-${nuevoNumeroProducto}">Costo Directo: 0</p>
        <p id="administracion-${nuevoNumeroProducto}">Administración (35%): 0</p>
        <p id="imprevistos-${nuevoNumeroProducto}">Imprevistos (3%): 0</p>
        <p id="utilidad-${nuevoNumeroProducto}">
            Utilidad 
            <select id="utilidad-select-${nuevoNumeroProducto}">
                <option value="45">45%</option>
                <option value="53" selected>53%</option>
                <option value="60">60%</option>
                <option value="70">70%</option>
                <option value="80">80%</option>
                <option value="90">90%</option>
                <option value="100">100%</option>
                <option value="103">103%</option>
                <option value="110">110%</option>
                <option value="120">120%</option>
                <option value="130">130%</option>
                <option value="140">140%</option>
                <option value="150">150%</option>
                <option value="160">160%</option>
            </select>: 0
        </p>
        <p id="oferta-antes-iva-${nuevoNumeroProducto}">Oferta Antes De Iva: 0</p>
        <p id="iva-${nuevoNumeroProducto}">Iva: 0</p>
        <p id="valor-oferta-${nuevoNumeroProducto}">Valor Oferta Impuestos Incluidos: 0</p>
    </div>
`;
    
        // Insertar el nuevo producto en la posición correcta
        let insertado = false;
        productosContainer.querySelectorAll('.producto').forEach(producto => {
            const numeroProducto = parseInt(producto.id.split('-')[1], 10);
            if (nuevoNumeroProducto < numeroProducto) {
                productosContainer.insertBefore(nuevoProducto, producto);
                insertado = true;
                return false; // Rompe el bucle forEach
            }
        });
        if (!insertado) {
            productosContainer.appendChild(nuevoProducto); // Si no se insertó, agregar al final
        }
    
        // Actualizar el número de producto dentro del div itemNumber
        actualizarNumeroProducto();
    
        cargarItemsProducto(productoId, nuevoNumeroProducto, 1, '');
    
        // Agregar botones de Confirmar, Editar, Eliminar y Duplicar
        const botonesContainer = document.createElement('div');
        botonesContainer.className = 'botones-container';
        const confirmarProductoBtn = document.createElement('button');
        confirmarProductoBtn.textContent = "Confirmar Producto";
        confirmarProductoBtn.addEventListener('click', function() {
            const seleccionItemsContainer = document.getElementById(`seleccion-items-container-${nuevoProducto.id.split('-')[1]}`);
            seleccionItemsContainer.style.display = 'none';
        });
        botonesContainer.appendChild(confirmarProductoBtn);
    
        const editarProductoBtn = document.createElement('button');
        editarProductoBtn.textContent = "Editar Producto";
        editarProductoBtn.addEventListener('click', function() {
            const seleccionItemsContainer = document.getElementById(`seleccion-items-container-${nuevoProducto.id.split('-')[1]}`);
            seleccionItemsContainer.style.display = 'block';
        });
        botonesContainer.appendChild(editarProductoBtn);
    
        const eliminarProductoBtn = document.createElement('button');
        eliminarProductoBtn.textContent = "Eliminar Producto";
        eliminarProductoBtn.classList.add('eliminar');
        eliminarProductoBtn.addEventListener('click', function() {
            const producto = document.getElementById(`producto-${nuevoNumeroProducto}`);
            const numeroEliminado = parseInt(nuevoProducto.id.split('-')[1], 10);
            numerosEliminados.push(numeroEliminado); // Añadir el número del producto eliminado al array
            producto.remove();
            actualizarNumeroProducto(); // Actualizar el número de producto visible
            actualizarTotalProducto(nuevoNumeroProducto); // Actualizar el total del producto
        });
        botonesContainer.appendChild(eliminarProductoBtn);
    
        const duplicarProductoBtn = document.createElement('button');
        duplicarProductoBtn.textContent = "Duplicar Producto";
        duplicarProductoBtn.addEventListener('click', function() {
            let nuevoNumeroProductoDuplicado;
            if (numerosEliminados.length > 0) {
                nuevoNumeroProductoDuplicado = numerosEliminados.shift();
            } else {
                nuevoNumeroProductoDuplicado = ++itemNumber;
            }
            const nuevoProductoDuplicado = nuevoProducto.cloneNode(true);
            nuevoProductoDuplicado.id = `producto-${nuevoNumeroProductoDuplicado}`;
            productosContainer.appendChild(nuevoProductoDuplicado);
            actualizarNumeroProducto(); // Actualizar el número de producto visible
            actualizarTotalProducto(nuevoNumeroProductoDuplicado); // Actualizar el total del producto
        });
        botonesContainer.appendChild(duplicarProductoBtn);
    
        nuevoProducto.appendChild(botonesContainer);
        descripcionInput.value = '';
        productoSelect.value = '';
    
        const utilidadSelect = document.getElementById(`utilidad-select-${nuevoNumeroProducto}`);
        utilidadSelect.addEventListener('change', function() {
            const porcentajeSeleccionado = parseFloat(utilidadSelect.value);
            const costoDirecto = parseFloat(document.getElementById(`costo-directo-${nuevoNumeroProducto}`).textContent.replace('Costo Directo: ', '').replace(/\./g, '').replace(',', '.'));
    
            const utilidadCalculada = calcularPorcentaje(costoDirecto, porcentajeSeleccionado);
            document.getElementById(`utilidad-${nuevoNumeroProducto}`).textContent = `Utilidad (${porcentajeSeleccionado}%): ${formatearNumero(utilidadCalculada)}`;
    
            // Actualizar totales adicionales
            actualizarTotalesExtras(nuevoNumeroProducto, costoDirecto);
        });
        
        nuevoProducto.appendChild(utilidadSelect);
    });
    
    
    document.addEventListener('DOMContentLoaded', function() {
        actualizarNumeroProducto();
    });

            // Función para agregar ítems temporales
            function agregarItemTemporal(productoId) {
                const descripcion = document.getElementById(`nuevo-item-descripcion-${productoId}`).value.trim();
                const precioInput = document.getElementById(`nuevo-item-precio-${productoId}`).value.trim();
                
                // Convertir el precio a formato numérico
                const precio = parseFloat(precioInput.replace(/\./g, '').replace(/,/g, '.'));
            
                if (isNaN(precio)) {
                    alert("El precio ingresado no es válido. Asegúrese de usar el formato correcto.");
                    return;
                }
            
                const cantidad = parseInt(document.getElementById(`nuevo-item-cantidad-${productoId}`).value.trim(), 10);
            
                if (!descripcion || isNaN(precio) || isNaN(cantidad) || cantidad <= 0 || !productoId) {
                    alert("Por favor, ingrese una descripción, precio, cantidad y seleccione un producto.");
                    return;
                }
            
                fetch('/agregar_item_temporal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        descripcion: descripcion,
                        precio: precio,
                        aprobado: false,
                        producto_id: productoId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Agregar el ítem al contenedor del producto
                        const contenedor = document.getElementById(`itemsseleccionados-${productoId}`);
                        const nuevaFila = document.createElement('tr');
                        const total = precio * cantidad;
                        nuevaFila.innerHTML = `
                            <td>${data.item_id}</td>
                            <td>Temporales</td>
                            <td>${descripcion}</td>
                            <td>Unidad</td>
                            <td>${formatearNumero(precio)}</td>
                            <td><input type="number" class="cantidad" value="${cantidad}" min="1" onchange="actualizarTotalProducto(${productoId})"></td>
                            <td class="total">${formatearNumero(total)}</td>
                            <td class="oculto">Temporal</td>
                            <td><button onclick="eliminarItemTemporal(${data.item_id}, ${productoId})">Eliminar</button></td>
                        `;
                        contenedor.appendChild(nuevaFila);
            
                        limpiarFormularioTemporal(productoId);
                        // Actualizar total del producto
                        actualizarTotalProducto(productoId);
                    } else {
                        alert('Error al agregar el ítem temporal: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
            
            
            function limpiarFormularioTemporal(productoId) {
                document.getElementById(`nuevo-item-descripcion-${productoId}`).value = '';
                document.getElementById(`nuevo-item-precio-${productoId}`).value = '';
                document.getElementById(`nuevo-item-cantidad-${productoId}`).value = '1';
            }
            
            
            

                 // Función para agregar ítems seleccionados y temporales al producto
            function agregarItemAlProducto(item, itemNumber) {
                        const itemsSeleccionadosContainer = document.getElementById(`itemsseleccionados-${itemNumber}`);
                        const materiaPrimaContainer = document.getElementById(`materiaprima-${itemNumber}`);
                        const consumiblesContainer = document.getElementById(`consumibles-${itemNumber}`);
                        const serviciosContainer = document.getElementById(`servicios-${itemNumber}`);
                        const manoDeObraContainer = document.getElementById(`manodeobra-${itemNumber}`);
                        const transporteContainer = document.getElementById(`transporte-${itemNumber}`);
                    
                        const idsSeleccionados = new Set();
                        document.querySelectorAll(`#itemsseleccionados-${itemNumber} tr`).forEach(fila => {
                            const itemId = fila.querySelector('td:first-child').textContent;
                            idsSeleccionados.add(itemId);
                        });
                    
                        const itemId = item.id;
                        if (idsSeleccionados.has(itemId)) {
                            mostrarNotificacion(`El ítem con ID ${itemId} ya ha sido agregado.`, 'warning');
                            return;
                        }
                        
                        const itemGrupo = item.tipo;
                        const itemDescripcion = item.descripcion;
                        const itemUnidad = "Unidad"; // Puedes ajustar esto según sea necesario
                        const itemPrecio = item.precio;
                    
                        const nuevaFila = document.createElement('tr');
                        nuevaFila.innerHTML = `
                            <td>${itemId}</td>
                            <td>${itemGrupo}</td>
                            <td>${itemDescripcion}</td>
                            <td>${itemUnidad}</td>
                            <td>${itemPrecio}</td>
                            <td><input type="number" min="1" value="1" class="cantidad" onchange="actualizarTotalProducto(${itemNumber})"></td>
                            <td class="total">${itemPrecio}</td>
                            <td class="oculto">${itemGrupo}</td>
                            <td><button onclick="eliminarItemSeleccionado(this)">Eliminar</button></td>
                        `;
                    
                        let container;
                        switch (itemGrupo) {
                            case 'Materia Prima':
                                container = materiaPrimaContainer;
                                break;
                            case 'Consumibles':
                                container = consumiblesContainer;
                                break;
                            case 'Servicios':
                                container = serviciosContainer;
                                break;
                            case 'Mano de obra e instalacion':
                                container = manoDeObraContainer;
                                break;
                            case 'Transportes':
                                container = transporteContainer;
                                break;
                            default:
                                container = itemsSeleccionadosContainer; // Para ítems temporales u otros tipos
                                break;
                        }
                    
                        // Añadir encabezado si aún no existe
                        if (container && !container.querySelector('.tipo-header')) {
                            const headerRow = document.createElement('tr');
                            headerRow.innerHTML = `<td colspan="9" class="tipo-header"><strong>${itemGrupo}</strong></td>`;
                            container.appendChild(headerRow);
                        }
                    
                        container.appendChild(nuevaFila);
                        idsSeleccionados.add(itemId);
                        actualizarTotalProducto(itemNumber);
                    
                        mostrarNotificacion('Ítem agregado correctamente.', 'success');
                    }


    
    function actualizarNumeroProducto() {
        const itemNumberDiv = document.getElementById('itemNumber');
        if (itemNumberDiv) {
            if (numerosEliminados.length > 0) {
                itemNumberDiv.textContent = Math.min(...numerosEliminados).toString();
            } else {
                itemNumberDiv.textContent = (itemNumber + 1).toString();
            }
        }
    }

    function cargarItemsProducto(productoId, itemNumber, pagina, busqueda) {
        fetch(`/items_por_producto/${productoId}?pagina=${pagina}&busqueda=${busqueda}`)
            .then(response => response.json())
            .then(data => {
                const items = data.items;
                const totalPaginas = data.totalPaginas;
                const seleccionItemsContainer = document.getElementById(`seleccion-items-${itemNumber}`);
                const paginacionContainer = document.getElementById(`paginacion-items-${itemNumber}`);
    
                seleccionItemsContainer.innerHTML = '';
    
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Seleccionar</th>
                            <th>Grupo</th>
                            <th>Descripción</th>
                            <th>Unidad</th>
                            <th>Precio</th>
                            <th class="oculto">Tipo</th> 
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td><input type="checkbox" id="item-${item.id}-${itemNumber}" value="${item.id}"></td>
                                <td>${item.categoria}</td>
                                <td>${item.descripcion}</td>
                                <td>${item.unidad}</td>
                                <td>${item.precio !== null ? item.precio : 'SIN PRECIO'}</td>
                                <td class="oculto">${item.tipo}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                seleccionItemsContainer.appendChild(table);
    
                paginacionContainer.innerHTML = '';
                const maxPagesToShow = 5;
                const half = Math.floor(maxPagesToShow / 2);
                let startPage = Math.max(1, pagina - half);
                let endPage = Math.min(totalPaginas, pagina + half);
    
                if (pagina - half < 1) {
                    endPage = Math.min(totalPaginas, endPage + (half - pagina + 1));
                }
                if (pagina + half > totalPaginas) {
                    startPage = Math.max(1, startPage - (pagina + half - totalPaginas));
                }
    
                if (pagina > 1) {
                    const firstButton = document.createElement('button');
                    firstButton.textContent = '<<';
                    firstButton.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, 1, busqueda));
                    paginacionContainer.appendChild(firstButton);
    
                    const prevButton = document.createElement('button');
                    prevButton.textContent = '<';
                    prevButton.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, pagina - 1, busqueda));
                    paginacionContainer.appendChild(prevButton);
                }
    
                for (let i = startPage; i <= endPage; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.disabled = i === pagina;
                    button.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, i, busqueda));
                    paginacionContainer.appendChild(button);
                }
    
                if (pagina < totalPaginas) {
                    const nextButton = document.createElement('button');
                    nextButton.textContent = '>';
                    nextButton.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, pagina + 1, busqueda));
                    paginacionContainer.appendChild(nextButton);
    
                    const lastButton = document.createElement('button');
                    lastButton.textContent = '>>';
                    lastButton.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, totalPaginas, busqueda));
                    paginacionContainer.appendChild(lastButton);
                }
    
                const buscador = document.getElementById(`buscar-item-${itemNumber}`);
                buscador.addEventListener('input', debounce(() => {
                    const busqueda = buscador.value;
                    cargarItemsProducto(productoId, itemNumber, 1, busqueda);
                }, 300));
            });
    }
    

    function agregarItemsSeleccionados(itemNumber) {
            const itemsSeleccionados = document.querySelectorAll(`#seleccion-items-${itemNumber} input[type="checkbox"]:checked`);        
            const materiaPrimaContainer = document.getElementById(`materiaprima-${itemNumber}`);
            const consumiblesContainer = document.getElementById(`consumibles-${itemNumber}`);
            const serviciosContainer = document.getElementById(`servicios-${itemNumber}`);
            const manoDeObraContainer = document.getElementById(`manodeobra-${itemNumber}`);
            const transporteContainer = document.getElementById(`transporte-${itemNumber}`);

            const idsSeleccionados = new Set();
            document.querySelectorAll(`#itemsseleccionados-${itemNumber} tr`).forEach(fila => {
                const itemId = fila.querySelector('td:first-child').textContent;
                idsSeleccionados.add(itemId);
            });
        
            itemsSeleccionados.forEach(itemCheckbox => {
                const itemId = itemCheckbox.value;
                if (idsSeleccionados.has(itemId)) {
                    mostrarNotificacion(`El ítem con ID ${itemId} ya ha sido agregado.`, 'warning');
                    return;
                }
                
                const itemGrupo = itemCheckbox.closest('tr').querySelector('td:nth-child(2)').textContent;
                const itemDescripcion = itemCheckbox.closest('tr').querySelector('td:nth-child(3)').textContent;
                const itemUnidad = itemCheckbox.closest('tr').querySelector('td:nth-child(4)').textContent;
                const itemPrecio = itemCheckbox.closest('tr').querySelector('td:nth-child(5)').textContent;
                const itemTipo = itemCheckbox.closest('tr').querySelector('td:nth-child(6)').textContent;
        
                const nuevaFila = document.createElement('tr');
                nuevaFila.innerHTML = `
                    <td>${itemId}</td>
                    <td>${itemGrupo}</td>
                    <td>${itemDescripcion}</td>
                    <td>${itemUnidad}</td>
                    <td>${itemPrecio}</td>
                    <td><input type="number" min="1" value="1" class="cantidad" onchange="actualizarTotalProducto(${itemNumber})"></td>
                    <td class="total">0</td>
                    <td class="oculto">${itemTipo}</td>
                    <td><button onclick="eliminarItemSeleccionado(this)">Eliminar</button></td>
                `;
        
                let container;
                switch (itemTipo) {
                    case 'Materia Prima':
                        container = materiaPrimaContainer;
                        break;
                    case 'Consumibles':
                        container = consumiblesContainer;
                        break;
                    case 'Servicios':
                        container = serviciosContainer;
                        break;
                    case 'Mano de obra e instalacion':
                        container = manoDeObraContainer;
                        break;
                    case 'Transportes':
                        container = transporteContainer;
                        break;
                }
        
                // Añadir encabezado si aún no existe
                if (container && !container.querySelector('.tipo-header')) {
                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = `<td colspan="9" class="tipo-header"><strong>${itemTipo}</strong></td>`;
                    container.appendChild(headerRow);
                }
        
                container.appendChild(nuevaFila);
                idsSeleccionados.add(itemId);
                actualizarTotalProducto(itemNumber);
            });
        
            mostrarNotificacion('Ítems agregados correctamente.', 'success');
        }
    
    
    
        function actualizarTotalProducto(itemNumber) {
            const contenedores = [
                document.getElementById(`materiaprima-${itemNumber}`),
                document.getElementById(`consumibles-${itemNumber}`),
                document.getElementById(`servicios-${itemNumber}`),
                document.getElementById(`manodeobra-${itemNumber}`),
                document.getElementById(`transporte-${itemNumber}`),
                document.getElementById(`itemsseleccionados-${itemNumber}`) // Agregar el contenedor de ítems temporales
            ];
            
            let total = 0;
            
            contenedores.forEach(container => {
                if (container) {
                    const filas = container.querySelectorAll('tr');
            
                    filas.forEach(fila => {
                        const precioElement = fila.querySelector('td:nth-child(5)');
                        const cantidadElement = fila.querySelector('input.cantidad');
            
                        if (precioElement && cantidadElement) {
                            let precioTexto = precioElement.textContent.trim();
                            let cantidadTexto = cantidadElement.value.trim();
            
                            // Convertir el precio a número, eliminando separadores de miles y usando punto como decimal
                            precioTexto = precioTexto.replace(/\./g, '').replace(/,/g, '.');
                            
                            const precio = parseFloat(precioTexto);
                            const cantidad = parseInt(cantidadTexto, 10);
            
                            if (!isNaN(precio) && !isNaN(cantidad)) {
                                const subtotal = precio * cantidad;
                                fila.querySelector('.total').textContent = formatearNumero(subtotal);
                                total += subtotal;
                            } else {
                                console.error('Error: Precio o cantidad no son números válidos');
                            }
                        } else {
                            console.error('Error: Elemento de precio o cantidad no encontrado');
                        }
                    });
                } else {
                    console.error('Error: Contenedor no encontrado', container);
                }
            });
            
            // Actualizar el costo directo
            document.getElementById(`costo-directo-${itemNumber}`).textContent = `Costo Directo: ${formatearNumero(total)}`;
            
            // Llamar a la función para actualizar los totales extras
            actualizarTotalesExtras(itemNumber, total);
        }
        
        
        

function calcularPorcentaje(valor, porcentaje) {
    return (valor * porcentaje) / 100;
}

function actualizarTotalesExtras(itemNumber, costoDirecto) {
    const administracion = calcularPorcentaje(costoDirecto, 35);
    const imprevistos = calcularPorcentaje(costoDirecto, 3);
    const utilidadSelect = document.getElementById(`utilidad-select-${itemNumber}`);
    const utilidadPorcentaje = parseFloat(utilidadSelect.value);
    const utilidad = calcularPorcentaje(costoDirecto, utilidadPorcentaje);

    const ofertaAntesIva = costoDirecto + administracion + imprevistos + utilidad;
    const iva = calcularPorcentaje(ofertaAntesIva, 19);
    const valorOferta = ofertaAntesIva + iva;

    document.getElementById(`administracion-${itemNumber}`).textContent = `Administración (35%): ${formatearNumero(administracion)}`;
    document.getElementById(`imprevistos-${itemNumber}`).textContent = `Imprevistos (3%): ${formatearNumero(imprevistos)}`;
    document.getElementById(`utilidad-${itemNumber}`).textContent = `Utilidad (${utilidadPorcentaje}%): ${formatearNumero(utilidad)}`;
    document.getElementById(`oferta-antes-iva-${itemNumber}`).textContent = `Oferta Antes De Iva: ${formatearNumero(ofertaAntesIva)}`;
    document.getElementById(`iva-${itemNumber}`).textContent = `Iva: ${formatearNumero(iva)}`;
    document.getElementById(`valor-oferta-${itemNumber}`).textContent = `Valor Oferta Impuestos Incluidos: ${formatearNumero(valorOferta)}`;

    console.log("actualizarTotalesExtras", itemNumber, costoDirecto);
}

function formatearNumero(numero) {
    return numero.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

}


    
    
    
function mostrarNotificacion(mensaje, tipo) {
        const notificacion = document.createElement('div');
        notificacion.className = `notificacion ${tipo}`;
        notificacion.textContent = mensaje;
        document.body.appendChild(notificacion);
        setTimeout(() => {
            notificacion.remove();
        }, 3000);
    }
    

    function eliminarItemSeleccionado(button) {
        const fila = button.closest('tr');
        const itemNumber = fila.closest('tbody').id.split('-')[1];
        fila.remove();
        actualizarTotalProducto(itemNumber); // Actualizar el total del producto después de eliminar el ítem
    }
    

    function verTodosItems(itemNumber, pagina, busqueda) {
        fetch(`/todos_los_items?pagina=${pagina}&busqueda=${busqueda}`)
            .then(response => response.json())
            .then(data => {
                const items = data.items;
                const totalPaginas = data.totalPaginas;
                const seleccionItemsContainer = document.getElementById(`seleccion-items-${itemNumber}`);
                const paginacionContainer = document.getElementById(`paginacion-items-${itemNumber}`);
    
                seleccionItemsContainer.innerHTML = '';
    
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Seleccionar</th>
                            <th>Grupo</th>
                            <th>Descripción</th>
                            <th>Unidad</th>
                            <th>Precio</th>
                            <th class="oculto">Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td><input type="checkbox" id="item-${item.id}-${itemNumber}" value="${item.id}"></td>
                                <td>${item.categoria}</td>
                                <td>${item.descripcion}</td>
                                <td>${item.unidad}</td>
                                <td>${item.precio !== null ? item.precio : 'SIN PRECIO'}</td>
                                <td class="oculto">${item.tipo}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                seleccionItemsContainer.appendChild(table);
    
                paginacionContainer.innerHTML = '';
                const maxPagesToShow = 5;
                const half = Math.floor(maxPagesToShow / 2);
                let startPage = Math.max(1, pagina - half);
                let endPage = Math.min(totalPaginas, pagina + half);
    
                if (pagina - half < 1) {
                    endPage = Math.min(totalPaginas, endPage + (half - pagina + 1));
                }
                if (pagina + half > totalPaginas) {
                    startPage = Math.max(1, startPage - (pagina + half - totalPaginas));
                }
    
                if (pagina > 1) {
                    const firstButton = document.createElement('button');
                    firstButton.textContent = '<<';
                    firstButton.addEventListener('click', () => verTodosItems(itemNumber, 1, busqueda));
                    paginacionContainer.appendChild(firstButton);
    
                    const prevButton = document.createElement('button');
                    prevButton.textContent = '<';
                    prevButton.addEventListener('click', () => verTodosItems(itemNumber, pagina - 1, busqueda));
                    paginacionContainer.appendChild(prevButton);
                }
    
                for (let i = startPage; i <= endPage; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.disabled = i === pagina;
                    button.addEventListener('click', () => verTodosItems(itemNumber, i, busqueda));
                    paginacionContainer.appendChild(button);
                }
    
                if (pagina < totalPaginas) {
                    const nextButton = document.createElement('button');
                    nextButton.textContent = '>';
                    nextButton.addEventListener('click', () => verTodosItems(itemNumber, pagina + 1, busqueda));
                    paginacionContainer.appendChild(nextButton);
    
                    const lastButton = document.createElement('button');
                    lastButton.textContent = '>>';
                    lastButton.addEventListener('click', () => verTodosItems(itemNumber, totalPaginas, busqueda));
                    paginacionContainer.appendChild(lastButton);
                }
    
                const buscador = document.getElementById(`buscar-item-${itemNumber}`);
                buscador.addEventListener('input', debounce(() => {
                    const busqueda = buscador.value;
                    verTodosItems(itemNumber, 1, busqueda);
                }, 300));
            });
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
</script>
</html>