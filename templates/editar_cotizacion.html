<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Cotizacion</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_cotizador.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>

        .resumen-costos {
            background-color: #2b2b2b;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            color: white;
        }

        .list-unstyled {
            list-style-type: none; /* Elimina los puntos o viñetas */
            padding-left: 0; /* Elimina el padding izquierdo */
            margin: 0; /* Opcional: elimina el margen si es necesario */
        }

        /* CSS para ocultar la tabla durante la carga */
        .loading-active table {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #888;
        }
        
        .iva-selector {
            margin: 10px 0;
            font-family: Arial, sans-serif; 
        }
        
        .iva-selector label {
            font-size: 16px;
            margin-right: 10px;
        }
        
        .iva-selector select {
            font-size: 16px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
        }
        
        .iva-selector select:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .navbar {
            background-color: #f8f9fa;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar_user {
            display: flex;
            flex: 1; /* Ocupa el espacio disponible */
            justify-content: center; /* Centra horizontalmente el contenido */
            align-items: center; /* Centra verticalmente el contenido */
            font-size: 1.25rem; /* Ajusta el tamaño del texto según sea necesario */
            font-weight: bold; /* Pone el texto en negrita */
        }
        

          
          .sidebar.collapsed {
            width: 0; /* Ocultar la barra lateral al cambiar el ancho a 0 */
            transform: translateX(-100%); /* Mover el sidebar fuera de la vista */
          }
          
          .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #DC0070;
            color: #ffffff;
            font-size: 20px;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
            cursor: pointer;
          }
          
          .menu-button {
            cursor: pointer;
            font-size: 24px;
            background: none;
            border: none;
          }
        
          .sidebar .list-unstyled li a i {
            margin-right: 10px;
            color: #fff; /* Color blanco para los iconos */
        }
        
        .sidebar .list-unstyled li a {
            color: #c8c9ce; /* Color de texto para los enlaces */
        }
        
        .sidebar .sub-components li {
            margin-left: 40px; /* Ajusta este valor según sea necesario */
        }
        
        .sidebar .sub-components li a {
            font-size: 16px; /* Ajusta el tamaño de la fuente */
            color: #e0e0e0; /* Color de texto más claro */
        }
        
        .sidebar-divider {
            border-top: 1px solid #fff; /* Línea blanca entre categorías */
        }
        
        .sidebar-header {
            display: none; /* Ocultar los encabezados que ya no son necesarios */
        }
        
        .sidebar {
            position: fixed;
            top: 0px; /* Altura del navbar */
            bottom: 0;
            left: 0;
            width: 250px;
            z-index: 1;
            background-color: #777777;
            padding-top: 20px;
            overflow-y: auto;
            padding: 20px;
        }
        
        .navbar_logout a {
            position: absolute;
            padding: 05px 10px;
            background-color: #DC0070;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            bottom: 12%;
            left: 25%;
        }
        
        .navbar_logout a {
            position: absolute;
            padding: 05px 10px;
            background-color: #DC0070;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            bottom: 12%;
          
        
          .navbar_logout a {
            position: absolute;
            padding: 05px 10px;
            background-color: #DC0070;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            bottom: 12%;
            left: 25%;
        }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="close-button" onclick="closeSidebar()">X</div>
    
        <div class="logo">
            <img src="{{ url_for('static', filename='images/LOGO_WHITE.png') }}" alt="Your Logo" class="logo">
        </div>
        <hr class="sidebar-divider">
        <ul class="list-unstyled components">
            <li>
                <a href="{{ url_for('routes.admin') }}">
                    <i class="fas fa-home"></i> Inicio
                </a>
            </li>
    
            {% if user_rol == 1 %}
            <li class="dropdown">
                <a class="dropdown-toggle" onclick="toggleDropdown('sub-components-1')">
                    <i class="fas fa-users"></i> Gestión de Usuarios
                    <i class="fas fa-chevron-down"></i>
                </a>
                <ul id="sub-components-1" class="list-unstyled sub-components">
                    <li>
                        <a href="{{ url_for('users.listar_usuarios') }}">
                            <i class="fas fa-eye"></i> Ver Usuarios
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('users.crear_usuario') }}">
                            <i class="fas fa-user-plus"></i> Crear Usuario
                        </a>
                    </li>
                </ul>
            </li>
            {% endif %}
    
            <li>
                <a href="{{ url_for('customers.listar_clientes') }}">
                    <i class="fas fa-handshake"></i> Gestión de Clientes
                </a>
            </li>
    
            <li>
                <a href="{{ url_for('routes.generar_catalogo') }}">
                    <i class="fas fa-brush"></i> Generar Catálogo
                </a>
            </li>
    
            <li class="dropdown">
                <a class="dropdown-toggle" onclick="toggleDropdown('sub-components-2')">
                    <i class="fas fa-receipt"></i> Gestión de Cotizaciones
                    <i class="fas fa-chevron-down"></i>
                </a>
                <ul id="sub-components-2" class="list-unstyled sub-components">
                    <li>
                        <a href="{{ url_for('routes.listar_cotizaciones') }}">
                            <i class="fas fa-eye"></i> Ver Cotizaciones
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('routes.generar_cotizacion') }}">
                            <i class="fas fa-plus"></i> Crear Cotización
                        </a>
                    </li>
                </ul>
            </li>
    
            <div class="navbar_logout">
                <a href="{{ url_for('users.logout') }}">Cerrar sesión</a>
            </div>
        </ul>
    </div>

    <nav class="navbar navbar-light">
        <div class="menu-button" onclick="toggleSidebar()">☰</div>
        <div class="navbar_user">
            <h6>Bienvenido, {{ session['username'] }}</h6>
        </div>
    </nav>


    <main role="main" class="col-md-10 ml-sm-auto col-lg-10 px-4">
    <section class="flex">
        <div class="seccion-derecha flex-item flex-grow">
            <div class="header-cotizacion">
                <h2>Datos de Cotización</h2>
                <button id="toggleDatosBtn" class="flecha-btn">></button>
            </div>
            <div class="grupo-columns" id="formulario-cotizacion" style="display: none;">
                <div class="grupo-columns" id="formulario-cotizacion">
                    <div class="grupo-columna">
                        <div class="grupo">
                            <label for="fecha_cotizacion"> Fecha: </label>
                            <input type="date" id="fecha_cotizacion" name="fecha_cotizacion" value="{{ cotizacion.fecha_cotizacion }}" required>
                        </div>
                        <div class="grupo">
                            <label for="cliente_cotizacion"> Cliente: </label>
                            <input type="text" id="cliente_cotizacion" name="cliente_cotizacion" value="{{ cotizacion.cliente_cotizacion }}" required>
                        </div>
                        <div class="grupo">
                            <label for="contacto_cotizacion"> Contacto: </label>
                            <input type="text" id="contacto_cotizacion" name="contacto_cotizacion" value="{{ cotizacion.contacto_cotizacion }}" required>
                        </div>
                        <div class="grupo">
                            <label for="proyecto_cotizacion"> Proyecto: </label>
                            <input type="text" id="proyecto_cotizacion" name="proyecto_cotizacion" value="{{ cotizacion.proyecto_cotizacion }}" required>
                        </div>
                        <div class="grupo">
                            <label for="vendedor_cotizacion"> Vendedor: </label>
                            <select id="vendedor_cotizacion" name="vendedor_cotizacion" required>
                                <option value="">Seleccionar</option>
                                {% for vendedor in vendedores %}
                                <option value="{{ vendedor.user_id }}" {% if vendedor.user_id == cotizacion.vendedor_cotizacion %}selected{% endif %}>
                                    {{ vendedor.user_name }} {{ vendedor.user_last_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="grupo">
                            <label for="negociacion"> N° Negociacion: </label>
                            <input type="text" id="negociacion" name="negociacion" value="{{ cotizacion.negociacion }}" required>
                        </div>
                    </div>
                    <div class="grupo-columna">
                        <div class="grupo">
                            <label for="forma_pago"> Forma de Pago: </label>
                            <select id="forma_pago" name="forma_pago" required>
                                <option value="">Seleccionar</option>
                                <option value="Contado" {% if cotizacion.forma_pago == 'Contado' %}selected{% endif %}>Contado</option>
                                <option value="Credito 30 Dias" {% if cotizacion.forma_pago == 'Credito 30 Dias' %}selected{% endif %}>Crédito 30 Días</option>
                                <option value="Credito 60 Dias" {% if cotizacion.forma_pago == 'Credito 60 Dias' %}selected{% endif %}>Crédito 60 Días</option>
                                <option value="50% abono - 50% entrega" {% if cotizacion.forma_pago == '50% abono - 50% entrega' %}selected{% endif %}>50% Abono - 50% Entrega</option>
                            </select>
                        </div>
                        <div class="grupo">
                            <label for="validez_cotizacion"> Validez: </label>
                            <select id="validez_cotizacion" name="validez_cotizacion" required>
                                <option value="15" {% if cotizacion.validez_cotizacion == '15' %}selected{% endif %}>15 días</option>
                                <option value="30" {% if cotizacion.validez_cotizacion == '30' %}selected{% endif %}>30 días</option>
                                <option value="60" {% if cotizacion.validez_cotizacion == '60' %}selected{% endif %}>60 días</option>
                            </select>
                        </div>
                        <div class="grupo">
                            <label for="descuento_cotizacion"> Porcentaje Descuento: </label>
                            <input type="number" id="descuento_cotizacion" name="descuento_cotizacion" value="{{ cotizacion.descuento_cotizacion }}" min="0" max="100" required>
                        </div>
                        <div class="grupo">
                            <label for="recibe_cotizacion"> Persona que Recibe: </label>
                            <input type="text" id="recibe_cotizacion" name="recibe_cotizacion" value="{{ cotizacion.recibe_cotizacion }}" required>
                        </div>
                        <div class="grupo">
                            <label for="numero_contacto"> Número de Contacto: </label>
                            <input type="tel" id="numero_contacto" name="numero_contacto" value="{{ cotizacion.numero_contacto_cotizacion }}" required>
                        </div>
                        <div class="grupo">
                            <label for="direccion_cotizacion"> Dirección: </label>
                            <textarea id="direccion_cotizacion" name="direccion_cotizacion" rows="3" required>{{ cotizacion.direccion_cotizacion }}</textarea>
                        </div>
                        <div class="iva-selector">
                            <label for="iva-select">IVA:</label>
                            <select id="iva-select" name="iva">
                                <option value="si" {% if cotizacion.iva == 'si' %}selected{% endif %}>Sí</option>
                                <option value="no" {% if cotizacion.iva == 'no' %}selected{% endif %}>No</option>
                            </select>
                        </div>
                    </div>
                </div>



                
            </div>
            <div class="acciones-globales">
                <button id="guardarCotizacionBtn">Guardar Cotización</button>
            </div>

        </div>
        <div class="seccion-izquierda flex-item">
            <h2> Productos </h2>
            <div class="item-descripcion-container">
                <div class="item-number" id="itemNumber"></div>
                <textarea id="descripcion" name="descripcion" rows="2" class="descripcion-input" placeholder="Ingrese la descripción del producto" required></textarea>
            </div>
            <div class="grupo">
                <label for="seleccionarLinea">Línea:</label>
                <select id="seleccionarLinea" name="seleccionarLinea">
                    <option value="">Seleccionar</option>
                    {% for linea in lineas %}
                        <option value="{{ linea.linea_id }}">{{ linea.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="grupo">
                <label for="seleccionarProducto">Producto:</label>
                <select id="seleccionarProducto" name="seleccionarProducto" onchange="cargarPorcentajesProducto()">
                    <option value="">Seleccionar</option>

                </select>

                <label for="alto-1">Alto: (Cm):</label>
                <input type="number" class="alto-input" name="alto" />
                <label for="ancho-1">Ancho: (Cm):</label>
                <input type="number" class="ancho-input" name="ancho" />
                <label for="fondo-1">Fondo: (Cm):</label>
                <input type="number" class="fondo-input" name="fondo" /> 
            </div>
            <div id="cantidad-container">
                <label for="cantidadUnidades">Cantidad de Unidades:</label>
                <div id="cantidadUnidades">
                    <input type="number" class="cantidad-input" name="cantidadUnidades" min="1" value="0" />
                    <button id="btnAgregarCantidad">+</button>
                    <button id="btnEliminarCantidad">-</button>
                </div>
            </div>
            <div class="grupo botones">
                <button id="btnCrear">Añadir</button>
            </div>
        </div>

    </section>
    <div id="productos-cotizacion" class="productos-cotizacion">
        <h2 style="text-align: center;">Productos de la Cotización</h2>
        <div id="notification-container" class="notification-container"></div>
    

        <div id="productos-container"></div>
    </div>

</main>

<script>
/*
    document.addEventListener('DOMContentLoaded', function() {
        // Asignar los datos a variables globales si es necesario
        const productosCotizados = {{ productos_cotizados | tojson }};
        const itemsCotizados = {{ items_cotizados | tojson }};
        const resumenCostos = {{ resumen_costos | tojson }};
    
        // Llamar a una función para actualizar el contenedor
        actualizarContenedor(productosCotizados, itemsCotizados, resumenCostos);
    });
    
    function actualizarContenedor(productos, items, resumen) {
        // Obtener el contenedor donde se van a mostrar los datos
        const contenedor = document.getElementById('productos-container');
    
        // Generar el HTML para los productos cotizados
        let productosHtml = productos.map(producto => `
            <div class="producto">
                <p>Descripción: ${producto.descripcion}</p>
                <p>Altura: ${producto.alto}</p>
                <p>Ancho: ${producto.ancho}</p>
                <p>Cantidad: ${producto.cantidades}</p>
                <!-- Añadir más campos si es necesario -->
            </div>
        `).join('');
    
        // Generar el HTML para los ítems cotizados
        let itemsHtml = items.map(item => `
            <div class="item">
                <p>Descripción: ${item.descripcion}</p>
                <p>Cantidad: ${item.cantidad}</p>
                <p>Grupo: ${item.grupo}</p>
                <p>Precio Unitario: ${item.precio_unitario}</p>
                <!-- Añadir más campos si es necesario -->
            </div>
        `).join('');
    
        // Generar el HTML para el resumen de costos
        let resumenHtml = resumen.map(costos => `
            <div class="resumen">
                <p>Administración: ${costos.administracion}</p>
                <p>Costo Directo: ${costos.costo_directo}</p>
                <p>Imprevistos: ${costos.imprevistos}</p>
                <p>IVA: ${costos.iva}</p>
                <!-- Añadir más campos si es necesario -->
            </div>
        `).join('');
    
        // Insertar el HTML generado en el contenedor
        contenedor.innerHTML = `
            <h2>Productos Cotizados</h2>
            ${productosHtml}
            <h2>Ítems Cotizados</h2>
            ${itemsHtml}
            <h2>Resumen de Costos</h2>
            ${resumenHtml}
        `;
    }
 */

 function obtenerMayorProductoId() {
    const productos = document.querySelectorAll('.producto');
    let maxId = 0;

    productos.forEach(producto => {
        // Obtener el ID del producto actual y extraer el número
        const id = producto.id.replace('producto-', '');
        const numeroId = parseInt(id, 10);
        
        if (numeroId > maxId) {
            maxId = numeroId;
        }
    });

    return maxId;
}

 const productosCotizados = {{ productos_cotizados | tojson }};
 const itemsCotizados = {{ items_cotizados | tojson }};
 const resumenCostos = {{ resumen_costos | tojson }};
 console.log(productosCotizados);
 console.log(itemsCotizados);
 console.log(resumenCostos);
 

 document.addEventListener('DOMContentLoaded', function() {
    // Asignar los datos a variables globales
    const productosCotizados = {{ productos_cotizados | tojson }};
    const itemsCotizados = {{ items_cotizados | tojson }};
    const resumenCostos = {{ resumen_costos | tojson }};
    
    // Llamar a la función para actualizar el contenedor al cargar la página
    productosCotizados.forEach(producto => agregarProducto(producto, itemsCotizados, resumenCostos));
});

// Función para añadir un producto al DOM de forma organizada
// Función para agrupar ítems por tipo
function agruparItemsPorTipo(items) {
    const tipos = ['Materia Prima', 'Servicios', 'Mano de Obra e Instalación', 'Transportes', 'Consumibles'];
    const itemsPorTipo = {};

    tipos.forEach(tipo => {
        itemsPorTipo[tipo] = items.filter(item => item.tipo === tipo);
    });

    return itemsPorTipo;
}

// Función para mostrar los ítems organizados por tipo
function mostrarItems(items) {
    const itemsPorTipo = agruparItemsPorTipo(items);
    let html = '';

    Object.keys(itemsPorTipo).forEach(tipo => {
        const itemsDelTipo = itemsPorTipo[tipo];

        if (itemsDelTipo.length > 0) {
            html += `<tr><td colspan="8" class="tipo-header"><strong>${tipo}</strong></td></tr>`;
            itemsDelTipo.forEach(item => {
                const precioUnitario = parseFloat(item.precio_unitario.replace(',', '.'));
                const cantidad = parseFloat(item.cantidad);
                const total = precioUnitario * cantidad;
            
                // Formatear el total al renderizar inicialmente
                const totalFormateado = total.toLocaleString('de-DE', {
                    minimumFractionDigits: 3,
                    maximumFractionDigits: 3,
                });
            
                html += `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.grupo}</td>
                        <td>${item.descripcion}</td>
                        <td>${item.unidad}</td>
                        <td>${precioUnitario.toFixed(3)}</td>
                        <td><input type="number" class="cantidad-item" data-precio="${precioUnitario}" value="${cantidad}" min="0"></td>
                        <td class="total-item">${totalFormateado}</td>
                        <td><button onclick="eliminarItemSeleccionado(this)">Eliminar</button></td>
                        <td class="oculto">${item.tipo}</td>
                    </tr>
                `;
            });
        }
    });

    if (html === '') {
        html += `<tr><td colspan="8">No hay ítems disponibles para este producto.</td></tr>`;
    }

    return html;
}

// Función para agregar un producto al DOM de forma organizada
function agregarProducto(producto, items) {
    console.log('Estructura del producto:', producto);

    // Crear nuevo div para el producto
    const nuevoProducto = document.createElement('div');
    nuevoProducto.className = 'producto';
    nuevoProducto.id = `producto-${producto.producto_id}`; // Asignar un ID único basado en el producto_id

    // Verificar si `producto.producto_nombre` está disponible
    const nombreProducto = producto.producto_nombre ? producto.producto_nombre : 'Nombre no disponible';

    // Crear HTML dinámico para el producto
    nuevoProducto.innerHTML = `
        <h3 contenteditable="true" style="color: #00b04f;">Producto ${producto.producto_id}: ${nombreProducto}</h3> 
        <h4 contenteditable="true">Descripción: ${producto.descripcion}</h4>
        <h4 contenteditable="true">Dimensiones: Alto: ${producto.alto}cm, Ancho: ${producto.ancho}cm, Fondo: ${producto.fondo}cm</h4>
    `;

    // Contenedor para los ítems seleccionados
    const itemsContainer = document.createElement('div');
    itemsContainer.className = 'items-seleccionados';
    itemsContainer.innerHTML = `
        <h4>Items Seleccionados</h4>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Grupo</th>
                    <th>Descripción</th>
                    <th>Unidad</th>
                    <th>Precio Unitario</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                    <th>Acciones</th>
                    <th class="oculto">Tipo</th>
                </tr>
            </thead>
            <tbody id="itemsseleccionados-${producto.producto_id}">
                ${items && items.length > 0 
                    ? mostrarItems(items) // Mostrar los ítems organizados por tipo
                    : '<tr><td colspan="8">No hay ítems disponibles para este producto.</td></tr>'}
            </tbody>
        </table>
    `;

    // Contenedor para el resumen de costos
    const resumenContainer = document.createElement('div');
    resumenContainer.className = 'resumen-costos';
    resumenContainer.innerHTML = `
        <h4>Resumen de Costos</h4>
        <p id="costo-directo-${producto.producto_id}">Costo Directo: 0</p>
        <p id="costo-unitario-${producto.producto_id}">Costo Unitario: 0</p>
        <p id="administracion-${producto.producto_id}">Administración: 0 <span id="porcentaje-administracion-${producto.producto_id}">(0%)</span></p>
        <p id="imprevistos-${producto.producto_id}">Imprevistos: 0 <span id="porcentaje-imprevistos-${producto.producto_id}">(0%)</span></p>
        <p id="utilidad-${producto.producto_id}">Utilidad: 0 <span id="porcentaje-utilidad-${producto.producto_id}">(0%)</span></p>
        <input type="number" id="utilidadSeleccionada-${producto.producto_id}" placeholder="El porcentaje mínimo es: 0" onchange="actualizarCostoDirecto(${producto.producto_id})">
        <p id="oferta-antes-iva-${producto.producto_id}">Oferta Antes De IVA: 0</p>
        <p id="iva-${producto.producto_id}">IVA: 0</p>
        <p style="color: #00b04f;" id="valor-oferta-${producto.producto_id}">Valor Oferta Impuestos Incluidos: 0</p>
    `;

    // Contenedor para los botones de acción
    const accionesContainer = document.createElement('div');
    accionesContainer.className = 'acciones';
    accionesContainer.innerHTML = `
        <button class="confirmar-producto-btn" data-producto-id="${producto.producto_id}">Confirmar Producto</button>
        <button class="editar-producto-btn" data-producto-id="${producto.producto_id}">Editar Producto</button>
        <button class="eliminar-producto-btn" data-producto-id="${producto.producto_id}">Eliminar Producto</button>
        <button class="duplicar-producto-btn" data-producto-id="${producto.producto_id}">Duplicar Producto</button>
    `;

    // Contenedor para la selección de ítems
    const seleccionItemsContainer = document.createElement('div');
    seleccionItemsContainer.id = `seleccion-items-container-${producto.producto_id}`;
    seleccionItemsContainer.style.display = 'none'; // Se ocultará inicialmente hasta que el usuario lo muestre
    seleccionItemsContainer.innerHTML = `
        <div>
            <h4>Seleccionar Ítems</h4>
            <input type="text" id="buscar-item-${producto.producto_id}" placeholder="Buscar ítems">
            <div id="seleccion-items-${producto.producto_id}"></div>
            <div id="paginacion-items-${producto.producto_id}"></div>
            <div class="botones-container">
                <button onclick="agregarItemsSeleccionadosNuevos(${producto.producto_id})">Agregar Ítems Seleccionados</button>
                <button onclick="verTodosItems(${producto.producto_id}, 1, '')">Ver Todos los Ítems</button>
            </div>
        </div>
    `;

    // Agregar todos los contenedores al nuevo producto
    nuevoProducto.appendChild(itemsContainer);
    nuevoProducto.appendChild(seleccionItemsContainer); // Añadir el contenedor de selección de ítems
    nuevoProducto.appendChild(resumenContainer);
    nuevoProducto.appendChild(accionesContainer);

    // Agregar el nuevo producto al contenedor principal de productos
    const productosContainer = document.getElementById('productos-container');
    productosContainer.appendChild(nuevoProducto);

    // Función para actualizar el costo directo basado en los ítems
    function actualizarCostoDirecto() {
        const itemsSeleccionados = nuevoProducto.querySelectorAll('#itemsseleccionados-' + producto.producto_id + ' .total-item');
        let costoDirecto = 0;

        itemsSeleccionados.forEach(item => {
            const total = parseFloat(item.textContent.replace('.', '').replace(',', '.'));
            costoDirecto += total;
        });

        // Actualizar el costo directo en el resumen
        const costoDirectoElement = nuevoProducto.querySelector(`#costo-directo-${producto.producto_id}`);
        costoDirectoElement.textContent = `Costo Directo: ${costoDirecto.toLocaleString('de-DE')}`;
    }

    // Actualizar el costo directo al cambiar la cantidad o eliminar un ítem
    const cantidadInputs = nuevoProducto.querySelectorAll('.cantidad-item');
    cantidadInputs.forEach(input => {
        input.addEventListener('input', function() {
            const precioUnitario = parseFloat(this.getAttribute('data-precio'));
            const cantidad = parseFloat(this.value);
            const total = precioUnitario * cantidad;
        
            // Usar toLocaleString para formatear el total con separadores de miles y decimales
            this.closest('tr').querySelector('.total-item').textContent = total.toLocaleString('de-DE', {
                minimumFractionDigits: 3, // Número mínimo de decimales
                maximumFractionDigits: 3, // Número máximo de decimales
            });
            actualizarCostoDirecto(); // Actualizar el costo directo
        });
    });

    // Forzar una actualización de los totales después de renderizar
    const totalItems = nuevoProducto.querySelectorAll('.total-item');
    totalItems.forEach(item => {
        const inputCantidad = item.closest('tr').querySelector('.cantidad-item');
        const precioUnitario = parseFloat(inputCantidad.getAttribute('data-precio'));
        const cantidad = parseFloat(inputCantidad.value);
        const total = precioUnitario * cantidad;
    
        // Formatear el total
        item.textContent = total.toLocaleString('de-DE', {
            minimumFractionDigits: 3,
            maximumFractionDigits: 3,
        });
    });

    // Llamar a la función de actualización inicial
    actualizarCostoDirecto();
}

    
        // Agregar productos nuevos
        document.getElementById('btnCrear').addEventListener('click', function() {
            const descripcionInput = document.getElementById('descripcion');
            const altoInput = document.querySelector('.alto-input');
            const anchoInput = document.querySelector('.ancho-input');
            const fondoInput = document.querySelector('.fondo-input');
            const productoSelect = document.getElementById('seleccionarProducto');
            const cantidadInput = document.querySelector('.cantidad-input');       
            const descripcion = descripcionInput.value.trim();
            const productoId = productoSelect.value;  
            const productoNombre = productoSelect.options[productoSelect.selectedIndex].text;
        
            const alto = altoInput.value.trim();
            const ancho = anchoInput.value.trim();
            const fondo = fondoInput.value.trim();
            const cantidad = parseInt(cantidadInput.value.trim(), 10);
        
            if (descripcion === "" || productoId === "" || cantidad <= 0) {
                alert("Por favor, ingrese una descripción, seleccione un producto y asegúrese de que la cantidad sea mayor a 0.");
                return;
            }
        
            let nuevoNumeroProducto;
        
            if (numerosEliminados.length > 0) {
                nuevoNumeroProducto = numerosEliminados.shift(); // Reutilizar el número más bajo disponible
            } else {
                // Obtener el mayor ID de los productos existentes en el DOM
                const mayorIdActual = obtenerMayorProductoId();
        
                // Asignar nuevoNumeroProducto como el mayorIdActual + 1
                nuevoNumeroProducto = mayorIdActual + 1;
            }
        
            // Crear el nuevo producto
            const nuevoProducto = document.createElement('div');
            nuevoProducto.className = 'producto';
            nuevoProducto.id = `producto-${nuevoNumeroProducto}`;
        
            // Generar las cabeceras dinámicas usando el arreglo valoresCantidad
            const { cantidadHeader, totalHeader } = generarCabeceras();
        
            // Crear el h4 que muestra las cantidades seleccionadas
            const cantidadesSeleccionadasHTML = valoresCantidad.map((valor, index) => 
                `<h4>Cantidad seleccionada (${index + 1}): ${valor} unidades</h4>`
            ).join('');
        
            // Cargar porcentajes desde el backend y almacenarlos en los atributos de data del elemento
            fetch(`/porcentajes/${productoId}`)
                .then(response => response.json())
                .then(porcentajes => {
                    nuevoProducto.dataset.administracion = porcentajes.administracion;
                    nuevoProducto.dataset.imprevistos = porcentajes.imprevistos;
                    nuevoProducto.dataset.utilidad = porcentajes.utilidad;
        
                    // Crear el contenido del nuevo producto
                    nuevoProducto.innerHTML = `
                <div class="producto" id="producto-${nuevoNumeroProducto}">
                    <h3 contenteditable="true" style="color: #00b04f;">Producto ${nuevoNumeroProducto}: ${productoNombre}</h3> 
                    <h4 contenteditable="true">Descripción: ${descripcion}</h4>
                    <h4 contenteditable="true">Alto (Cm): ${alto} || Ancho (Cm): ${ancho} || Fondo (Cm): ${fondo} |</h4>
        
                        <!-- Añadimos el productoId con un nombre diferente -->
                        <input type="hidden" name="producto_seleccionado_id" value="${productoId}">
    
                </div>
        
                        ${cantidadesSeleccionadasHTML}
                        <div class="itemsseleccionados">
                            <h4>Items Seleccionados</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Grupo</th>
                                        <th>Descripción</th>
                                        <th>Unidad</th>
                                        <th>Precio</th>
                                        ${cantidadHeader}
                                        ${totalHeader}
                                        <th class="oculto">Tipo</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsseleccionados-${nuevoNumeroProducto}">
                                    <tbody id="materiaprima-${nuevoNumeroProducto}"></tbody>
                                    <tbody id="consumibles-${nuevoNumeroProducto}"></tbody>
                                    <tbody id="servicios-${nuevoNumeroProducto}"></tbody>
                                    <tbody id="manodeobra-${nuevoNumeroProducto}"></tbody>
                                    <tbody id="transporte-${nuevoNumeroProducto}"></tbody>
                                </tbody>
                            </table>
                        </div>
                        <div id="seleccion-items-container-${nuevoNumeroProducto}" style="display: none;">
                            <div>
                                <h4>Seleccionar Ítems</h4>
                                <input type="text" id="buscar-item-${nuevoNumeroProducto}" placeholder="Buscar ítems">
        
                                <div id="seleccion-items-${nuevoNumeroProducto}"></div>
                                <div id="paginacion-items-${nuevoNumeroProducto}"></div>
                                <div class="botones-container">
                                    <button onclick="agregarItemsSeleccionados(${nuevoNumeroProducto})">Agregar Ítems Seleccionados</button>
                                    <button onclick="verTodosItems(${nuevoNumeroProducto}, 1, '')">Ver Todos los Ítems</button>
                                </div>
                            </div>
                        </div>
        
                        <!-- Botón para mostrar el formulario -->
                        <button id="toggleFormularioBtn-${nuevoNumeroProducto}" onclick="toggleFormulario(${nuevoNumeroProducto})">Agregar Nuevo Ítem</button>
        
                        <!-- Formulario para agregar ítems temporales -->
                        <div class="form-agregar-item-manual" id="formAgregarItem-${nuevoNumeroProducto}" data-producto-id="${nuevoNumeroProducto}">
                            <h4>Agregar Nuevo Ítem</h4>
                            <input type="text" id="nuevo-item-descripcion-${nuevoNumeroProducto}" placeholder="Descripción del Ítem">
                            <input type="number" id="nuevo-item-precio-${nuevoNumeroProducto}" placeholder="Precio del Ítem">
                            <input type="number" id="nuevo-item-cantidad-${nuevoNumeroProducto}" placeholder="Cantidad del Ítem" value="1" min="1">
                            <button id="btnAgregarItemTemporal-${nuevoNumeroProducto}" onclick="agregarItemTemporal(${nuevoNumeroProducto})">Agregar Ítem Temporal</button>
                        </div>
        
                        <div class="resumen-costos">
                            ${valoresCantidad.map((valor, index) => `
                                <div class="resumen-costos-individual" id="resumen-costos-${nuevoNumeroProducto}-${index}">
                                    <h4>Resumen de Costos (${valor})</h4>
                                    <p id="costo-directo-${nuevoNumeroProducto}-${index}">Costo Directo: 0</p>
                                    <p id="costo-unitario-${nuevoNumeroProducto}-${index}">Costo Directo Unitario: 0</p>
                                    <p id="administracion-${nuevoNumeroProducto}-${index}">Administración: 0 <span id="porcentaje-administracion-${nuevoNumeroProducto}-${index}">(0%)</span></p>
                                    <p id="imprevistos-${nuevoNumeroProducto}-${index}">Imprevistos: 0 <span id="porcentaje-imprevistos-${nuevoNumeroProducto}-${index}">(0%)</span></p>
                                    <p id="utilidad-${nuevoNumeroProducto}-${index}">Utilidad: 0 <span id="porcentaje-utilidad-${nuevoNumeroProducto}-${index}">(0%)</span></p>
                                    <input type="number" id="utilidadSeleccionada-${nuevoNumeroProducto}-${index}" placeholder="El porcentaje mínimo es: ${porcentajes.utilidad}" onchange="actualizarTotalProducto(${nuevoNumeroProducto})">
                                    <p id="oferta-antes-iva-${nuevoNumeroProducto}-${index}">Oferta Antes De IVA: 0</p>
                                    <p id="iva-${nuevoNumeroProducto}-${index}">IVA: 0</p>
                                    <p style="color: #00b04f;" id="valor-oferta-${nuevoNumeroProducto}-${index}">Valor Oferta Impuestos Incluidos: 0</p>
                                </div>
                            `).join('')}
                        </div>
        
                        <div class="acciones">
                            <button class="confirmar-producto-btn" data-producto-id="${nuevoNumeroProducto}">Confirmar Producto</button>
                            <button class="editar-producto-btn" data-producto-id="${nuevoNumeroProducto}">Editar Producto</button>
                            <button class="eliminar-producto-btn" data-producto-id="${nuevoNumeroProducto}">Eliminar Producto</button>
                            <button class="duplicar-producto-btn" data-producto-id="${nuevoNumeroProducto}">Duplicar Producto</button>
                        </div>
                    `;
        
                    productosContainer.appendChild(nuevoProducto);
        
                    // Limpiar los campos de entrada después de agregar el producto
                    descripcionInput.value = '';
                    productoSelect.value = '';
                    
                    // Insertar el nuevo producto en la posición correcta
                    let insertado = false;
                    productosContainer.querySelectorAll('.producto').forEach(producto => {
                        const numeroProducto = parseInt(producto.id.split('-')[1], 10);
                        if (nuevoNumeroProducto < numeroProducto) {
                            productosContainer.insertBefore(nuevoProducto, producto);
                            insertado = true;
                            return false; // Rompe el bucle forEach
                        }
                    });
                    if (!insertado) {
                        productosContainer.appendChild(nuevoProducto); // Si no se insertó, agregar al final
                    }
        
                    // Actualizar el número de producto dentro del div itemNumber
                    actualizarNumeroProducto();
        
                    cargarItemsProducto(productoId, nuevoNumeroProducto, 1, '');
        
                // Añadir manejadores de eventos para la utilidad
                let timeout;
                valoresCantidad.forEach((valor, index) => {
                    const utilidadInput = document.getElementById(`utilidadSeleccionada-${nuevoNumeroProducto}-${index}`);
                    if (utilidadInput) {
                        utilidadInput.addEventListener('input', function() {
                            clearTimeout(timeout);
                            timeout = setTimeout(() => {
                                const nuevoValorUtilidad = parseFloat(this.value);
                                if (!isNaN(nuevoValorUtilidad)) {
                                    const productoElement = document.querySelector(`#producto-${nuevoNumeroProducto}`);
                                    if (productoElement) {
                                        const porcentajeMinimoUtilidad = parseFloat(productoElement.dataset.utilidad);
                                        if (nuevoValorUtilidad >= porcentajeMinimoUtilidad) {
                                            // Solo realiza el cálculo y actualización si el valor es válido
                                            actualizarTotalProducto(nuevoNumeroProducto, nuevoValorUtilidad);
                                        } else {
                                            alert(`El porcentaje de utilidad debe ser al menos ${porcentajeMinimoUtilidad}%`);
                                            this.value = ''; // Limpiar el campo para forzar un valor válido
                                        }
                                    }
                                }
                            }, 300); 
                        });
                    } else {
                        console.error(`Elemento con ID utilidadSeleccionada-${nuevoNumeroProducto}-${index} no encontrado.`);
                    }
                });
    
                // Actualizar los totales al agregar un nuevo producto
                actualizarTotalesExtras(nuevoNumeroProducto, 0); // Inicia con costo directo 0
            })
            .catch(error => {
                console.error('Error al cargar los porcentajes:', error);
            });
    });

    // ------------------------------------------- botones producto del back

    
    function actualizarIdsYEventos(element, nuevoId) {
        console.log(`Actualizando IDs y eventos para el nuevo ID: ${nuevoId}`);
        
        element.querySelectorAll('[id]').forEach(child => {
            const partesId = child.id.split('-');
            partesId[partesId.length - 1] = nuevoId;
            child.id = partesId.join('-');
        });
        element.querySelectorAll('[for]').forEach(child => {
            const partesFor = child.getAttribute('for').split('-');
            partesFor[partesFor.length - 1] = nuevoId;
            child.setAttribute('for', partesFor.join('-'));
        });
        element.querySelectorAll('[name]').forEach(child => {
            const partesName = child.name.split('-');
            partesName[partesName.length - 1] = nuevoId;
            child.name = partesName.join('-');
        });
        element.querySelectorAll('[data-producto-id]').forEach(child => {
            child.setAttribute('data-producto-id', nuevoId);
        });
    
        // Actualizar los eventos `onclick` de los botones
        element.querySelectorAll('button').forEach(button => {
            const originalOnClick = button.getAttribute('onclick');
            if (originalOnClick) {
                button.setAttribute('onclick', originalOnClick.replace(/\d+/, nuevoId));
            }
        });
    
        // Asegurarse de que los eventos de cambio de cantidad y utilidad están configurados
        element.querySelectorAll('.cantidad-item').forEach(input => {
            input.addEventListener('input', function() {
                const precioUnitario = parseFloat(this.getAttribute('data-precio').replace(/,/g, ''));
                const cantidad = parseFloat(this.value);
                const total = (precioUnitario * cantidad).toFixed(3);
                this.closest('tr').querySelector('.total-item').textContent = total.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            });
        });
    

        element.querySelectorAll('.cantidad-item').forEach(input =>{
            input.addEventListener('input', function(){
                const precioUnitario = parseFloat(this.getAttribute('data-precio').replace(/,/g, ''));
                const cantidad = parseFloat(this.value);
                const total = (precioUnitario * cantidad).toFixed(3);
                this.closest('tr').querySelector('.total-item').textContent = total.replace(/\B(?=(\d{3})+(?!\d))/g, ',')
            });
        });


        element.querySelectorAll('.utilidadSeleccionada').forEach(input => {
            input.addEventListener('input', function() {
                let timeout;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    const nuevoValorUtilidad = parseFloat(this.value);
                    if (!isNaN(nuevoValorUtilidad)) {
                        const productoElement = document.querySelector(`#producto-${nuevoId}`);
                        if (productoElement) {
                            const porcentajeMinimoUtilidad = parseFloat(productoElement.dataset.utilidad);
                            if (nuevoValorUtilidad >= porcentajeMinimoUtilidad) {
                                actualizarTotalProducto(nuevoId, nuevoValorUtilidad);
                                actualizarResumenDeCostos(nuevoId); // Actualiza el resumen de costos
                            } else {
                                alert(`El porcentaje de utilidad debe ser al menos ${porcentajeMinimoUtilidad}%`);
                            }
                        }
                    }
                }, 300);
            });
        });
    }

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const content = document.querySelector('main'); // Selecciona el contenedor principal

        if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
            content.style.marginLeft = '250px'; // Ajusta el margen izquierdo del contenido
            content.style.width = 'calc(100% - 250px)'; // Ajusta el ancho del contenido en función del ancho del sidebar expandido
        } else {
            sidebar.classList.add('collapsed');
            content.style.marginLeft = '0'; // Restaura el margen izquierdo del contenido
            content.style.width = '100%'; // Restaura el ancho del contenido al 100%
        }
    }

    function closeSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const content = document.querySelector('main'); // Selecciona el contenedor principal

        sidebar.classList.add('collapsed');
        content.style.marginLeft = '0'; // Restaura el margen izquierdo del contenido
        content.style.width = '100%'; // Restaura el ancho del contenido al 100%
    }

    function toggleDropdown(id) {
        var dropdown = document.getElementById(id);
        var icon = event.currentTarget.querySelector('i.fas.fa-chevron-down, i.fas.fa-chevron-up');
    
        if (dropdown.style.display === "block") {
            dropdown.style.display = "none";
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            dropdown.style.display = "block";
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    }


    // Obtener la fecha actual en formato YYYY-MM-DD
    const today = new Date().toISOString().slice(0, 10);

    // Establecer la fecha actual como valor por defecto
    document.getElementById('fecha_cotizacion').value = today;


    // Funciones para el formulario de cotizacion
    
    document.getElementById('toggleDatosBtn').addEventListener('click', function() {
        const formularioCotizacion = document.getElementById('formulario-cotizacion');
        formularioCotizacion.style.display = formularioCotizacion.style.display === 'none' ? 'flex' : 'none';
        this.textContent = formularioCotizacion.style.display === 'none' ? '>' : 'v';
        this.classList.toggle('expandido');
    });


    document.addEventListener('DOMContentLoaded', function(){
        const formularioCotizacion = document.getElementById('formulario-cotizacion');
        formularioCotizacion.style.display= 'flex';
    });

    //funcion para evento de seleccion de linea

    document.addEventListener('DOMContentLoaded', function() {
        const lineaSelect = document.getElementById('seleccionarLinea');
        const productoSelect = document.getElementById('seleccionarProducto');

        // Función para cargar todos los productos
        function cargarTodosLosProductos() {
            fetch('/todos_los_productos') // Asegúrate de que esta ruta devuelva todos los productos en formato JSON
                .then(response => response.json())
                .then(productos => {
                    productoSelect.innerHTML = '<option value="">Seleccionar</option>'; // Reiniciar opciones
                    productos.forEach(producto => {
                        const option = document.createElement('option');
                        option.value = producto.id;
                        option.textContent = producto.nombre;
                        option.dataset.lineaId = producto.linea_id; // Guardamos el ID de la línea en un data attribute
                        productoSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar todos los productos:', error);
                });
        }

    // Función para cargar productos filtrados por línea
    function cargarProductosPorLinea(lineaId) {
        if (lineaId) {
            fetch(`/productos_por_linea/${lineaId}`)
                .then(response => response.json())
                .then(productos => {
                    productoSelect.innerHTML = '<option value="">Seleccionar</option>'; // Reiniciar opciones
                    productos.forEach(producto => {
                        const option = document.createElement('option');
                        option.value = producto.id;
                        option.textContent = producto.nombre;
                        option.dataset.lineaId = producto.linea_id; // Guardamos el ID de la línea en un data attribute
                        productoSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error(`Error al cargar productos para la línea ${lineaId}:`, error);
                });
        } else {
            // Si no se selecciona ninguna línea, cargar todos los productos
            cargarTodosLosProductos();
        }
    }

    // Cargar todos los productos al cargar la página
    cargarTodosLosProductos();

    // Evento para cuando se cambia la selección de línea
    lineaSelect.addEventListener('change', function() {
        const lineaId = this.value;
        cargarProductosPorLinea(lineaId);
    });

    // Evento para cuando se cambia la selección de producto
    productoSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const lineaId = selectedOption.dataset.lineaId;

        if (lineaId) {
            // Actualizar la selección de línea sin disparar el evento 'change' nuevamente
            if (lineaSelect.value !== lineaId) {
                lineaSelect.value = lineaId;
                // Opcional: Si deseas filtrar los productos al actualizar la línea automáticamente
                // cargarProductosPorLinea(lineaId);
            }
        }
    });
});
    
    //funcion que consulta los porcentajes de cada producto en el backend

    function cargarPorcentajesProducto() {
        const productoId = document.getElementById('seleccionarProducto').value;
    
        if (productoId) {
            fetch(`/porcentajes/${productoId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la solicitud: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(porcentajes => {
                    if (!porcentajes.error) {
                        // Guardar los porcentajes en el objeto del producto seleccionado
                        const productoElement = document.querySelector(`#producto-${productoId}`);
                        if (productoElement) {
                            productoElement.dataset.administracion = porcentajes.administracion;
                            productoElement.dataset.imprevistos = porcentajes.imprevistos;
                            productoElement.dataset.utilidad = porcentajes.utilidad;
    
                            // Establecer el valor mínimo en el input de utilidad
                            const inputUtilidad = document.getElementById('utilidadSeleccionada');
                            
                            inputUtilidad.placeholder = `El porcentaje mínimo es cargarPorcentajesProducto: ${porcentajes.utilidad}`;
                            inputUtilidad.min = porcentajes.utilidad;
                        }
                    }
                })

        }
    }

    let valoresCantidad = [];

    // Función para actualizar los valores de los inputs
    function actualizarValoresCantidad() {
        const cantidadInputs = document.querySelectorAll('#cantidadUnidades .cantidad-input');
        valoresCantidad = Array.from(cantidadInputs).map(input => parseInt(input.value, 10) || 1); // Default to 1 if NaN
    }
    
    // Añadir eventos para actualizar los valores
    document.getElementById('btnAgregarCantidad').addEventListener('click', function() {
        const cantidadContainer = document.getElementById('cantidadUnidades');
    
        // Crear nuevo input
        const newInput = document.createElement('input');
        newInput.type = 'number';
        newInput.className = 'cantidad-input';
        newInput.name = 'cantidadUnidades';
        newInput.min = '1';
        newInput.value = '1';
        cantidadContainer.appendChild(newInput);
    
        // Actualizar los valores
        actualizarValoresCantidad();
    });
    
    document.getElementById('btnEliminarCantidad').addEventListener('click', function() {
        const cantidadContainer = document.getElementById('cantidadUnidades');
        const cantidadInputs = document.querySelectorAll('#cantidadUnidades .cantidad-input');
    
        // Eliminar el último input si hay más de uno
        if (cantidadInputs.length > 1) {
            cantidadContainer.removeChild(cantidadInputs[cantidadInputs.length - 1]);
            actualizarValoresCantidad();
        }
    });
    
    // Actualizar valores al cambiar inputs
    document.addEventListener('input', function(event) {
        if (event.target.classList.contains('cantidad-input')) {
            actualizarValoresCantidad();
        }
    });
    

    
    document.getElementById('btnEliminarCantidad').addEventListener('click', function() {
        const cantidadContainer = document.getElementById('cantidadUnidades');
        const cantidadInputs = document.querySelectorAll('#cantidadUnidades .cantidad-input');
        
        // Eliminar el último input si hay más de uno
        if (cantidadInputs.length > 1) {
            cantidadContainer.removeChild(cantidadInputs[cantidadInputs.length - 1]);
        }
        
        // Contar los inputs
        console.log('Número de inputs de cantidad:', cantidadInputs.length - 1);
    });

    let itemNumber = 0;
    let numerosEliminados = [];
    let temporalItemID = 1; // ID inicial para ítems temporales, será decreciente

    const productosContainer = document.getElementById('productos-container'); // Define en el ámbito global

    function generarCabeceras() {
        const cantidadHeader = valoresCantidad.map(valor => `<th>Cantidad (${valor})</th>`).join('');
        const totalHeader = valoresCantidad.map(valor => `<th>Total (${valor})</th>`).join('');
        return { cantidadHeader, totalHeader };
    }


    
 // Delegación de eventos para los botones de productos
 document.addEventListener('click', function(event) {
    const target = event.target;

    if (target.matches('.confirmar-producto-btn')) {
        const seleccionItemsContainer = document.getElementById(`seleccion-items-container-${target.dataset.productoId}`);
        seleccionItemsContainer.style.display = 'none';
    } else if (target.matches('.editar-producto-btn')) {
        const seleccionItemsContainer = document.getElementById(`seleccion-items-container-${target.dataset.productoId}`);
        seleccionItemsContainer.style.display = 'block';


    } else if (target.matches('.eliminar-producto-btn')) {
        const producto = document.getElementById(`producto-${target.dataset.productoId}`);
        numerosEliminados.push(parseInt(target.dataset.productoId, 10)); // Añadir el número del producto eliminado al array
        producto.remove();
        actualizarNumeroProducto(); // Actualizar el número de producto visible
        actualizarResumenesDeCostos(); // Actualizar los resúmenes de costos
    } else if (target.matches('.duplicar-producto-btn')) {
        let nuevoNumeroProductoDuplicado;
        if (numerosEliminados.length > 0) {
            nuevoNumeroProductoDuplicado = numerosEliminados.shift();
        } else {
            nuevoNumeroProductoDuplicado = ++itemNumber;
        }

        // Clonar el producto
        const productoOriginal = document.getElementById(`producto-${target.dataset.productoId}`);
        const nuevoProductoDuplicado = productoOriginal.cloneNode(true);

        // Actualizar el ID del producto clonado
        nuevoProductoDuplicado.id = `producto-${nuevoNumeroProductoDuplicado}`;

// Actualizar los IDs de los elementos internos y los eventos del producto duplicado
const actualizarIdsYEventos = (element, nuevoId) => {
    element.querySelectorAll('[id]').forEach(child => {
        const partesId = child.id.split('-');
        partesId[partesId.length - 1] = nuevoId;
        child.id = partesId.join('-');
    });
    element.querySelectorAll('[for]').forEach(child => {
        const partesFor = child.getAttribute('for').split('-');
        partesFor[partesFor.length - 1] = nuevoId;
        child.setAttribute('for', partesFor.join('-'));
    });
    element.querySelectorAll('[name]').forEach(child => {
        const partesName = child.name.split('-');
        partesName[partesName.length - 1] = nuevoId;
        child.name = partesName.join('-');
    });
    element.querySelectorAll('[data-producto-id]').forEach(child => {
        child.setAttribute('data-producto-id', nuevoId);
    });

    // Actualizar los eventos `onclick` de los botones
    element.querySelectorAll('button').forEach(button => {
        const originalOnClick = button.getAttribute('onclick');
        if (originalOnClick) {
            button.setAttribute('onclick', originalOnClick.replace(/\d+/, nuevoId));
        }
    });

    // Asegurarse de que los eventos de cambio de cantidad y utilidad están configurados
    element.querySelectorAll('.cantidad').forEach(input => {
        input.addEventListener('change', function() {
            actualizarTotalProducto(nuevoId);
            actualizarResumenDeCostos(nuevoId); // Actualiza el resumen de costos
        });
    });
    element.querySelectorAll('.utilidadSeleccionada').forEach(input => {
        input.addEventListener('input', function() {
            let timeout;
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const nuevoValorUtilidad = parseFloat(this.value);
                if (!isNaN(nuevoValorUtilidad)) {
                    const productoElement = document.querySelector(`#producto-${nuevoId}`);
                    if (productoElement) {
                        const porcentajeMinimoUtilidad = parseFloat(productoElement.dataset.utilidad);
                        if (nuevoValorUtilidad >= porcentajeMinimoUtilidad) {
                            actualizarTotalProducto(nuevoId, nuevoValorUtilidad);
                            actualizarResumenDeCostos(nuevoId); // Actualiza el resumen de costos
                        } else {
                            alert(`El porcentaje de utilidad debe ser al menos ${porcentajeMinimoUtilidad}%`);
                        }
                    }
                }
            }, 300);
        });
    });
};

// Después de duplicar el producto, actualiza los IDs y agrega los eventos
actualizarIdsYEventos(nuevoProductoDuplicado, nuevoNumeroProductoDuplicado);

        // Actualizar el contenido específico del producto duplicado
        nuevoProductoDuplicado.querySelector('h3').textContent = `Producto ${nuevoNumeroProductoDuplicado}: ${productoOriginal.querySelector('h3').textContent.split(': ')[1]}`;

        // Agregar el producto duplicado al contenedor de productos
        productosContainer.appendChild(nuevoProductoDuplicado);

        // Actualizar el número de producto visible
        actualizarNumeroProducto();


// Añadir manejadores de eventos a los nuevos elementos del producto duplicado
let timeout;
nuevoProductoDuplicado.querySelectorAll('.utilidadSeleccionada').forEach(input => {
    input.addEventListener('input', function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            const nuevoValorUtilidad = parseFloat(this.value);
            if (!isNaN(nuevoValorUtilidad)) {
                const productoElement = document.querySelector(`#producto-${nuevoNumeroProductoDuplicado}`);
                if (productoElement) {
                    const porcentajeMinimoUtilidad = parseFloat(productoElement.dataset.utilidad);
                    if (nuevoValorUtilidad >= porcentajeMinimoUtilidad) {
                        actualizarTotalProducto(nuevoNumeroProductoDuplicado, nuevoValorUtilidad);
                        actualizarResumenDeCostos(nuevoNumeroProductoDuplicado); // Actualiza el resumen de costos
                    } else {
                        alert(`El porcentaje de utilidad debe ser al menos ${porcentajeMinimoUtilidad}%`);
                    }
                }
            }
        }, 300);
    });
});

// Añadir manejador de eventos para cambios en las cantidades
nuevoProductoDuplicado.querySelectorAll('.cantidad').forEach(input => {
    input.addEventListener('change', function() {
        actualizarTotalProducto(nuevoNumeroProductoDuplicado);
        actualizarResumenDeCostos(nuevoNumeroProductoDuplicado); // Actualiza el resumen de costos
    });
});


function guardarCambios(productoId) {
    const producto = document.getElementById(`producto-${productoId}`);
    
    // Obtener valores editados
    const descripcion = producto.querySelector('h4').textContent.replace('Descripción: ', '').trim();
    const alto = producto.querySelector('h4:nth-of-type(2)').textContent.split('Alto (Cm): ')[1].split(' || ')[0].trim();
    const ancho = producto.querySelector('h4:nth-of-type(2)').textContent.split('Ancho (Cm): ')[1].split(' || ')[0].trim();
    const fondo = producto.querySelector('h4:nth-of-type(2)').textContent.split('Fondo (Cm): ')[1].trim();
    
    // Actualizar los datos del producto en el DOM si es necesario
    producto.querySelector('h4').textContent = `Descripción: ${descripcion}`;
    producto.querySelector('h4:nth-of-type(2)').textContent = `Alto (Cm): ${alto} || Ancho (Cm): ${ancho} || Fondo (Cm): ${fondo} |`;

    // Puedes agregar lógica adicional si necesitas actualizar el backend o hacer otras operaciones

    alert('Cambios guardados.');
}


        // Modificación para manejar eventos en el producto duplicado
        nuevoProductoDuplicado.querySelectorAll('.confirmar-producto-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const seleccionItemsContainer = document.getElementById(`seleccion-items-container-${nuevoNumeroProductoDuplicado}`);
                seleccionItemsContainer.style.display = 'none';
            });
        });

        nuevoProductoDuplicado.querySelectorAll('.editar-producto-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const seleccionItemsContainer = document.getElementById(`seleccion-items-container-${nuevoNumeroProductoDuplicado}`);
                seleccionItemsContainer.style.display = 'block';
            });
        });

        nuevoProductoDuplicado.querySelectorAll('.eliminar-producto-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const producto = document.getElementById(`producto-${nuevoNumeroProductoDuplicado}`);
                numerosEliminados.push(parseInt(nuevoNumeroProductoDuplicado, 10)); // Añadir el número del producto eliminado al array
                producto.remove();
                actualizarNumeroProducto(); // Actualizar el número de producto visible
                actualizarResumenesDeCostos(); // Actualizar los resúmenes de costos
            });
        });

        // Botón para Agregar Ítems
        const btnAgregarItemTemporal = nuevoProductoDuplicado.querySelector(`#btnAgregarItemTemporal-${nuevoNumeroProductoDuplicado}`);
        if (btnAgregarItemTemporal) {
            btnAgregarItemTemporal.addEventListener('click', function() {
                agregarItemTemporal(nuevoNumeroProductoDuplicado);
            });
        }

        const agregarItemsSeleccionadosBtn = nuevoProductoDuplicado.querySelector(`button[onclick^="agregarItemsSeleccionados"]`);
        if (agregarItemsSeleccionadosBtn) {
            agregarItemsSeleccionadosBtn.setAttribute('onclick', `agregarItemsSeleccionados(${nuevoNumeroProductoDuplicado})`);
        }
    }
});


document.addEventListener('DOMContentLoaded', function() {
    actualizarNumeroProducto();
});

function actualizarResumenesDeCostos() {
    document.querySelectorAll('.producto').forEach(producto => {
        const productoId = producto.id.split('-')[1];
        actualizarTotalProducto(productoId);
    });
}

function editarProducto(productoId) {
    const productoDiv = document.getElementById(`producto-${productoId}`);
    
    // Convertir el h4 de descripción a un textarea editable
    const descripcionElement = productoDiv.querySelector('h4:nth-child(2)');
    const descripcionTexto = descripcionElement.textContent.replace("Descripción: ", "");
    descripcionElement.innerHTML = `<textarea>${descripcionTexto}</textarea>`;
    
    // Convertir los campos de medidas a inputs
    const medidasElement = productoDiv.querySelector('h4:nth-child(3)');
    const [alto, ancho, fondo] = medidasElement.textContent.split(' || ').map(texto => texto.split(': ')[1]);
    medidasElement.innerHTML = `
        <label>Alto (Cm):</label><input type="number" value="${alto}">
        <label>Ancho (Cm):</label><input type="number" value="${ancho}">
        <label>Fondo (Cm):</label><input type="number" value="${fondo}">
    `;
    
    // Si deseas editar la cantidad, puedes hacer algo similar

}



function toggleFormulario(numeroProducto) {
    const formulario = document.getElementById(`formAgregarItem-${numeroProducto}`);
    if (formulario.style.display === 'none' || formulario.style.display === '') {
        formulario.style.display = 'block';
    } else {
        formulario.style.display = 'none';
    }
}


            // Función para agregar ítems temporales
            function agregarItemTemporal(productoId) {
                const descripcion = document.getElementById(`nuevo-item-descripcion-${productoId}`).value.trim();
                const precioInput = document.getElementById(`nuevo-item-precio-${productoId}`).value.trim();
                
                // Convertir el precio a formato numérico
                const precio = parseFloat(precioInput.replace(/\./g, '').replace(/,/g, '.'));
            
                if (isNaN(precio)) {
                    alert("El precio ingresado no es válido. Asegúrese de usar el formato correcto.");
                    return;
                }
            
                const cantidad = parseInt(document.getElementById(`nuevo-item-cantidad-${productoId}`).value.trim(), 10);
            
                if (!descripcion || isNaN(precio) || isNaN(cantidad) || cantidad <= 0 || !productoId) {
                    alert("Por favor, ingrese una descripción, precio, cantidad y seleccione un producto.");
                    return;
                }
            
                fetch('/agregar_item_temporal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        descripcion: descripcion,
                        precio: precio,
                        aprobado: false,
                        producto_id: productoId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Agregar el ítem al contenedor del producto
                        const contenedor = document.getElementById(`itemsseleccionados-${productoId}`);
                        const itemId = data.item_id;
                        
                        // Generar las celdas de cantidad y total dinámicamente
                        const cantidadCeldas = valoresCantidad.map((valor, i) => 
                            `<td><input type="number" min="1" value="${valor}" class="cantidad" data-index="${i}" onchange="actualizarTotalProducto(${productoId})"></td>`
                        ).join('');
            
                        const totalCeldas = valoresCantidad.map(() => 
                            `<td class="total">0</td>`
                        ).join('');
                        
                        const nuevaFila = document.createElement('tr');
                        nuevaFila.innerHTML = `
                            <td>${itemId}</td>
                            <td>Temporales</td>
                            <td>${descripcion}</td>
                            <td>Unidad</td>
                            <td>${formatearNumero(precio)}</td>
                            ${cantidadCeldas} 
                            ${totalCeldas}    
                            <td class="oculto">Temporal</td>
                            <td><button onclick="eliminarItemTemporal(this, ${itemId}, ${productoId})">Eliminar</button></td>
                        `;
                        contenedor.appendChild(nuevaFila);
            
                        limpiarFormularioTemporal(productoId);
                        // Actualizar total del producto
                        actualizarTotalProducto(productoId);
                    } else {
                        alert('Error al agregar el ítem temporal: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
            
            
            function limpiarFormularioTemporal(productoId) {
                document.getElementById(`nuevo-item-descripcion-${productoId}`).value = '';
                document.getElementById(`nuevo-item-precio-${productoId}`).value = '';
                document.getElementById(`nuevo-item-cantidad-${productoId}`).value = '1';
            }
            
            
            

// Función para agregar ítems seleccionados y temporales al producto
function agregarItemAlProducto(item, itemNumber) {
    const itemsSeleccionadosContainer = document.getElementById(`itemsseleccionados-${itemNumber}`);
    const materiaPrimaContainer = document.getElementById(`materiaprima-${itemNumber}`);
    const consumiblesContainer = document.getElementById(`consumibles-${itemNumber}`);
    const serviciosContainer = document.getElementById(`servicios-${itemNumber}`);
    const manoDeObraContainer = document.getElementById(`manodeobra-${itemNumber}`);
    const transporteContainer = document.getElementById(`transporte-${itemNumber}`);
    
    const idsSeleccionados = new Set();
    document.querySelectorAll(`#itemsseleccionados-${itemNumber} tr`).forEach(fila => {
        const itemId = fila.querySelector('td:first-child').textContent;
        idsSeleccionados.add(itemId);
    });

    const itemId = item.id;
    if (idsSeleccionados.has(itemId)) {
        mostrarNotificacion(`El ítem con ID ${itemId} ya ha sido agregado.`, 'warning');
        return;
    }
    
    const itemGrupo = item.tipo;
    const itemDescripcion = item.descripcion;
    const itemUnidad = "Unidad"; // Puedes ajustar esto según sea necesario
    const preciosEscalonados = item.precios_escalonados; // Obtener precios escalonados del item

    // Crear las celdas de cantidad y total dinámicamente basadas en valoresCantidad
    const cantidadCeldas = valoresCantidad.map((valor, i) => 
        `<td><input type="number" min="1" value="${valor}" class="cantidad" data-index="${i}" onchange="actualizarTotalProducto(${itemNumber})"></td>`
    ).join('');
    
    const totalCeldas = valoresCantidad.map(() => 
        `<td class="total">0</td>`
    ).join('');
    
    const nuevaFila = document.createElement('tr');
    nuevaFila.innerHTML = `
        <td>${itemId}</td>
        <td>${itemGrupo}</td>
        <td>${itemDescripcion}</td>
        <td>${itemUnidad}</td>
        <td id="precio-${itemId}">${item.precio || 'SIN PRECIO'}</td>
        ${cantidadCeldas}
        ${totalCeldas}
        <td class="oculto">${itemGrupo}</td>
        <td><button onclick="eliminarItemSeleccionado(this)">Eliminar</button></td>
    `;
    
    // Guardar precios escalonados en un atributo data
    nuevaFila.setAttribute('data-precios-escalonados', JSON.stringify(preciosEscalonados));
    
    let container;
    switch (itemGrupo) {
        case 'Materia Prima':
            container = materiaPrimaContainer;
            break;
        case 'Consumibles':
            container = consumiblesContainer;
            break;
        case 'Servicios':
            container = serviciosContainer;
            break;
        case 'Mano de Obra e Instalacion':
            container = manoDeObraContainer;
            break;
        case 'Transportes':
            container = transporteContainer;
            break;
        default:
            container = itemsSeleccionadosContainer;
            break;
    }
    
    if (container && !container.querySelector('.tipo-header')) {
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `<td colspan="${5 + valoresCantidad.length * 2}" class="tipo-header"><strong>${itemGrupo}</strong></td>`;
        container.appendChild(headerRow);
    }
    
    container.appendChild(nuevaFila);
    idsSeleccionados.add(itemId);
    
    mostrarNotificacion('Ítem agregado correctamente.', 'success');
}



    
    function actualizarNumeroProducto() {
        const itemNumberDiv = document.getElementById('itemNumber');
        if (itemNumberDiv) {
            if (numerosEliminados.length > 0) {
                itemNumberDiv.textContent = Math.min(...numerosEliminados).toString();
            } else {
                itemNumberDiv.textContent = (itemNumber + 1).toString();
            }
        }
    }

    function cargarItemsProducto(productoId, itemNumber, pagina, busqueda) {
        fetch(`/items_por_producto/${productoId}?pagina=${pagina}&busqueda=${busqueda}`)
            .then(response => response.json())
            .then(data => {
                const items = data.items;
                const totalPaginas = data.totalPaginas;
                const seleccionItemsContainer = document.getElementById(`seleccion-items-${itemNumber}`);
                const paginacionContainer = document.getElementById(`paginacion-items-${itemNumber}`);
    
                seleccionItemsContainer.innerHTML = '';
    
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Seleccionar</th>
                            <th>Grupo</th>
                            <th>Descripción</th>
                            <th>Unidad</th>
                            <th>Precio</th>
                            <th class="oculto">Tipo</th> 
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td><input type="checkbox" id="item-${item.id}-${itemNumber}" value="${item.id}"></td>
                                <td>${item.categoria}</td>
                                <td>${item.descripcion}</td>
                                <td>${item.unidad}</td>
                                <td>${item.precio !== null ? item.precio : 'SIN PRECIO'}</td>
                                <td class="oculto">${item.tipo}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                seleccionItemsContainer.appendChild(table);
    
                paginacionContainer.innerHTML = '';
                const maxPagesToShow = 5;
                const half = Math.floor(maxPagesToShow / 2);
                let startPage = Math.max(1, pagina - half);
                let endPage = Math.min(totalPaginas, pagina + half);
    
                if (pagina - half < 1) {
                    endPage = Math.min(totalPaginas, endPage + (half - pagina + 1));
                }
                if (pagina + half > totalPaginas) {
                    startPage = Math.max(1, startPage - (pagina + half - totalPaginas));
                }
    
                if (pagina > 1) {
                    const firstButton = document.createElement('button');
                    firstButton.textContent = '<<';
                    firstButton.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, 1, busqueda));
                    paginacionContainer.appendChild(firstButton);
    
                    const prevButton = document.createElement('button');
                    prevButton.textContent = '<';
                    prevButton.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, pagina - 1, busqueda));
                    paginacionContainer.appendChild(prevButton);
                }
    
                for (let i = startPage; i <= endPage; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.disabled = i === pagina;
                    button.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, i, busqueda));
                    paginacionContainer.appendChild(button);
                }
    
                if (pagina < totalPaginas) {
                    const nextButton = document.createElement('button');
                    nextButton.textContent = '>';
                    nextButton.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, pagina + 1, busqueda));
                    paginacionContainer.appendChild(nextButton);
    
                    const lastButton = document.createElement('button');
                    lastButton.textContent = '>>';
                    lastButton.addEventListener('click', () => cargarItemsProducto(productoId, itemNumber, totalPaginas, busqueda));
                    paginacionContainer.appendChild(lastButton);
                }
    
                const buscador = document.getElementById(`buscar-item-${itemNumber}`);
                buscador.addEventListener('input', debounce(() => {
                    const busqueda = buscador.value;
                    cargarItemsProducto(productoId, itemNumber, 1, busqueda);
                }, 300));
            });
    }
    
    function formatearNumeroOriginal(numero) {
        // Si el número es un entero, no mostrar decimales
        const partes = numero.split(',');
        if (partes.length === 1 || partes[1] === '00') {
            return partes[0];
        } else {
            return numero;
        }
    }
    
    function convertirAFormatoOriginal(precioUnitario, cantidad) {
        // Convertir el precio unitario al formato numérico
        const precio = parseFloat(precioUnitario.replace(/\./g, '').replace(',', '.'));
        const total = precio * cantidad;
        
        // Convertir el total de vuelta al formato original
        let totalFormateado = total.toLocaleString('de-DE', {
            minimumFractionDigits: 2, // Mantener dos decimales
            maximumFractionDigits: 2
        }).replace('.', ',');
        
        return formatearNumeroOriginal(totalFormateado);
    }
    
    function actualizarCostoDirecto(productoId) {
        const itemsSeleccionados = document.querySelectorAll(`#itemsseleccionados-${productoId} .total-item`);
        let costoDirecto = 0;
    
        itemsSeleccionados.forEach(item => {
            const total = item.textContent.replace('.', '').replace(',', '.');
            costoDirecto += parseFloat(total);
        });
    
        // Actualizar el costo directo en el resumen
        const costoDirectoElement = document.querySelector(`#costo-directo-${productoId}`);
        costoDirectoElement.textContent = `Costo Directo: ${convertirAFormatoOriginal(costoDirectoElement.textContent, 1)}`;
    }
    
    function agregarItemsSeleccionadosNuevos(productoId) {
        const itemsSeleccionadosContainer = document.getElementById(`itemsseleccionados-${productoId}`);
        
        if (!itemsSeleccionadosContainer) {
            console.error(`Contenedor itemsseleccionados-${productoId} no encontrado. Verifica el ID en el HTML.`);
            return;
        }
        
        const checkboxes = document.querySelectorAll(`#seleccion-items-${productoId} input[type="checkbox"]:checked`);
        
        if (checkboxes.length === 0) {
            alert('No has seleccionado ningún ítem.');
            return;
        }
    
        checkboxes.forEach(checkbox => {
            const fila = checkbox.closest('tr');
            const id = checkbox.value;
            const tipo = fila.querySelector('td:nth-child(6)').innerText;
            
            const precioUnitario = fila.querySelector('td:nth-child(5)').innerText; // Mantener formato original
            const cantidad = 1;  // Inicializamos con 1 como valor por defecto
            const valorTexto = precioUnitario.replace(/\./g, '').replace(',', '.');
            const precio = parseFloat(valorTexto);
            const total = precio * cantidad;
    
            // Crear una nueva fila para agregar al tbody
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${id}</td>
                <td>${tipo}</td>
                <td>${fila.querySelector('td:nth-child(3)').innerText}</td>
                <td>${fila.querySelector('td:nth-child(4)').innerText}</td>
                <td>${precioUnitario}</td>
                <td><input type="number" class="cantidad-item" data-precio="${precioUnitario}" value="${cantidad}" min="1"></td>
                <td class="total-item">${total.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td><button onclick="eliminarItemSeleccionado(this)">Eliminar</button></td>
            `;
            
            let tipoHeaderRow = Array.from(itemsSeleccionadosContainer.querySelectorAll('.tipo-header')).find(row => row.textContent.includes(tipo));
            
            if (!tipoHeaderRow) {
                tipoHeaderRow = document.createElement('tr');
                tipoHeaderRow.classList.add('tipo-header');
                tipoHeaderRow.innerHTML = `<td colspan="8"><strong>${tipo}</strong></td>`;
                itemsSeleccionadosContainer.appendChild(tipoHeaderRow);
            }
            
            const nextHeader = tipoHeaderRow.nextElementSibling;
            if (nextHeader && nextHeader.classList.contains('tipo-header')) {
                itemsSeleccionadosContainer.insertBefore(newRow, nextHeader);
            } else {
                itemsSeleccionadosContainer.appendChild(newRow);
            }
            
            // Añadir un evento para recalcular el total cuando cambie la cantidad
            const cantidadInput = newRow.querySelector('.cantidad-item');
            const totalCell = newRow.querySelector('.total-item');
            cantidadInput.addEventListener('input', function() {
                const nuevaCantidad = parseFloat(cantidadInput.value);
                const nuevoTotal = (parseFloat(cantidadInput.getAttribute('data-precio').replace(/\./g, '').replace(',', '.')) * nuevaCantidad).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                totalCell.innerText = nuevoTotal;
                actualizarCostoDirecto(productoId); // Asegurarse de que se actualice el costo directo
            });
            
            checkbox.checked = false;
        });
    
        // Llamar a actualizarCostoDirecto después de agregar ítems
        actualizarCostoDirecto(productoId);
        verificarValoresIndividuales(productoId);
        verificarSumaTotal(productoId);
        actualizarCostoDirecto(productoId);
    }
    

    

    // <---------------------- FUNCION PARA AGREGAR ITEMS A LOS PRODUCTOS NO TRAIDOS DE BD--------------->

    function agregarItemsSeleccionados(itemNumber) {
        const itemsSeleccionados = document.querySelectorAll(`#seleccion-items-${itemNumber} input[type="checkbox"]:checked`);
        const materiaPrimaContainer = document.getElementById(`materiaprima-${itemNumber}`);
        const consumiblesContainer = document.getElementById(`consumibles-${itemNumber}`);
        const serviciosContainer = document.getElementById(`servicios-${itemNumber}`);
        const manoDeObraContainer = document.getElementById(`manodeobra-${itemNumber}`);
        const transporteContainer = document.getElementById(`transporte-${itemNumber}`);
        
        const idsSeleccionados = new Set();
        document.querySelectorAll(`#itemsseleccionados-${itemNumber} tr`).forEach(fila => {
            const itemId = fila.querySelector('td:first-child').textContent;
            idsSeleccionados.add(itemId);
        });
    
        itemsSeleccionados.forEach(itemCheckbox => {
            const itemId = itemCheckbox.value;
            if (idsSeleccionados.has(itemId)) {
                mostrarNotificacion(`El ítem con ID ${itemId} ya ha sido agregado.`, 'warning');
                return;
            }
    
            const itemGrupo = itemCheckbox.closest('tr').querySelector('td:nth-child(2)').textContent;
            const itemDescripcion = itemCheckbox.closest('tr').querySelector('td:nth-child(3)').textContent;
            const itemUnidad = itemCheckbox.closest('tr').querySelector('td:nth-child(4)').textContent;
            const itemPrecio = itemCheckbox.closest('tr').querySelector('td:nth-child(5)').textContent;
            const itemTipo = itemCheckbox.closest('tr').querySelector('td:nth-child(6)').textContent;
    
            // Crear las celdas de cantidad y total dinámicamente basadas en valoresCantidad
            const cantidadCeldas = valoresCantidad.map((valor, i) => 
                `<td><input type="number" min="1" value="${valor}" class="cantidad" data-index="${i}" onchange="actualizarTotalProducto(${itemNumber})"></td>`
            ).join('');
            
            const totalCeldas = valoresCantidad.map(() => 
                `<td class="total">0</td>`
            ).join('');
    
            const nuevaFila = document.createElement('tr');
            nuevaFila.innerHTML = `
                <td>${itemId}</td>
                <td>${itemGrupo}</td>
                <td>${itemDescripcion}</td>
                <td>${itemUnidad}</td>
                <td>${itemPrecio}</td>
                ${cantidadCeldas} <!-- Aquí se generan los td de cantidad -->
                ${totalCeldas}    <!-- Aquí se generan los td de total -->
                <td class="oculto">${itemTipo}</td>
                <td><button onclick="eliminarItemSeleccionado(this)">Eliminar</button></td>
            `;
    
            let container;
            switch (itemTipo) {
                case 'Materia Prima':
                    container = materiaPrimaContainer;
                    break;
                case 'Consumibles':
                    container = consumiblesContainer;
                    break;
                case 'Servicios':
                    container = serviciosContainer;
                    break;
                case 'Mano de Obra e Instalacion':
                    container = manoDeObraContainer;
                    break;
                case 'Transportes':
                    container = transporteContainer;
                    break;
                default:
                    console.error('Tipo de ítem desconocido:', itemTipo);
                    return;
            }
    
            // Añadir encabezado si aún no existe
            if (container && !container.querySelector('.tipo-header')) {
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `<td colspan="${5 + valoresCantidad.length * 2}" class="tipo-header"><strong>${itemTipo}</strong></td>`;
                container.appendChild(headerRow);
            }
    
            container.appendChild(nuevaFila);
            idsSeleccionados.add(itemId);
            actualizarTotalProducto(itemNumber);
        });
    
        mostrarNotificacion('Ítems agregados correctamente.', 'success');
    }
    
    
    
    function calcularPrecioUnitario(preciosEscalonados, cantidad) {
        // Encuentra el precio unitario adecuado basado en la cantidad
        for (const escalonado of preciosEscalonados) {
            if (cantidad >= escalonado.min_cantidad && (escalonado.max_cantidad === 0 || cantidad <= escalonado.max_cantidad)) {
                return parseFloat(escalonado.precio_unitario.replace(/\./g, '').replace(/,/g, '.'));
            }
        }
        return 0; // Precio por defecto si no se encuentra el rango adecuado
    }
    
    function actualizarTotalProducto(itemNumber) {
        const contenedores = [
            document.getElementById(`materiaprima-${itemNumber}`),
            document.getElementById(`consumibles-${itemNumber}`),
            document.getElementById(`servicios-${itemNumber}`),
            document.getElementById(`manodeobra-${itemNumber}`),
            document.getElementById(`transporte-${itemNumber}`),
            document.getElementById(`itemsseleccionados-${itemNumber}`)
        ];
    
        // Mantenemos el total por cada cantidad
        const subtotalPorCantidad = Array(valoresCantidad.length).fill(0);
    
        contenedores.forEach(container => {
            if (container) {
                const filas = container.querySelectorAll('tr');
                filas.forEach(fila => {
                    const precioElement = fila.querySelector('td:nth-child(5)');
                    const cantidadInputs = fila.querySelectorAll('input.cantidad');
                    const preciosEscalonados = JSON.parse(fila.getAttribute('data-precios-escalonados') || '[]');
    
                    if (precioElement && cantidadInputs.length > 0) {
                        let precio = parseFloat(precioElement.textContent.trim().replace(/\./g, '').replace(/,/g, '.'));
    
                        // Si hay precios escalonados, calcular el precio basado en la cantidad
                        if (preciosEscalonados.length > 0) {
                            cantidadInputs.forEach((input, index) => {
                                const cantidad = parseFloat(input.value.trim()) || 0;
                                const precioEscalonado = preciosEscalonados.find(pe => cantidad >= pe.min_cantidad && (cantidad <= pe.max_cantidad || pe.max_cantidad === 0));
    
                                if (precioEscalonado) {
                                    precio = parseFloat(precioEscalonado.precio_unitario);
                                }
    
                                const subtotal = precio * cantidad;
                                const totalElement = fila.querySelectorAll('.total')[index];
                                if (totalElement) {
                                    totalElement.textContent = formatearNumero(subtotal);
                                }
                                subtotalPorCantidad[index] += subtotal;
                            });
                        } else {
                            // Si no hay precios escalonados, usar el precio fijo
                            cantidadInputs.forEach((input, index) => {
                                const cantidad = parseFloat(input.value.trim()) || 0;
                                const subtotal = precio * cantidad;
                                const totalElement = fila.querySelectorAll('.total')[index];
                                if (totalElement) {
                                    totalElement.textContent = formatearNumero(subtotal);
                                }
                                subtotalPorCantidad[index] += subtotal;
                            });
                        }
                    }
                });
            }
        });
    
        // Obtener la cantidad de unidades del producto
        const cantidadInputs = document.querySelectorAll('#cantidadUnidades .cantidad-input');
        cantidadInputs.forEach((input, index) => {
            const cantidadUnidades = parseFloat(input.value) || 1;
            const nuevoValorUtilidad = parseFloat(document.getElementById(`utilidadSeleccionada-${itemNumber}-${index}`).value) || null;
            actualizarTotalesExtras(itemNumber, subtotalPorCantidad[index], nuevoValorUtilidad, cantidadUnidades, index);
        });
    }
    
    // <---------------------- actualizar resumen de productos agregados en edicion---------------------------->

    function verificarValoresIndividuales(productoId) {
        const itemsContainer = document.getElementById(`itemsseleccionados-${productoId}`);
        
        if (!itemsContainer) {
            console.error('Contenedor no encontrado.');
            return;
        }
    
        const totalItems = itemsContainer.querySelectorAll('.total-item');
        
        totalItems.forEach(item => {
            const valorTexto = item.textContent;
            const valorConvertido = convertirValor(valorTexto);
            console.log('Texto:', valorTexto, 'Convertido:', valorConvertido);
        });
    }
    
    // Función para verificar la suma total
    function verificarSumaTotal(productoId) {
        const itemsContainer = document.getElementById(`itemsseleccionados-${productoId}`);
        
        if (!itemsContainer) {
            console.error('Contenedor no encontrado.');
            return;
        }
    
        const totalItems = itemsContainer.querySelectorAll('.total-item');
        let sumaTotal = 0;
    
        totalItems.forEach(item => {
            const valorTexto = item.textContent;
            const valorNumerico = convertirValor(valorTexto);
            sumaTotal += valorNumerico;
        });
    
        console.log('Suma Total:', sumaTotal);
    }
    
// Función para convertir el valor de texto a número
function convertirValor(valorTexto) {
    // Elimina los puntos (separadores de miles) y reemplaza la coma por punto decimal
    return parseFloat(valorTexto.replace(/\./g, '').replace(',', '.'));
}

// Función para actualizar el costo directo
function actualizarCostoDirecto(productoId) {
    // Obtener el contenedor de los ítems seleccionados
    const itemsContainer = document.getElementById(`itemsseleccionados-${productoId}`);
    
    if (!itemsContainer) return;

    // Obtener todos los elementos con la clase total-item dentro del contenedor
    const totalItems = itemsContainer.querySelectorAll('.total-item');
    
    // Calcular la suma de los totales
    let sumaTotal = 0;
    totalItems.forEach(item => {
        const valorTexto = item.textContent;
        const valorNumerico = convertirValor(valorTexto);
        console.log('Texto:', valorTexto, 'Convertido:', valorNumerico);
        sumaTotal += valorNumerico;
    });

    console.log('Suma Total:', sumaTotal);

    // Actualizar el campo "Costo Directo" en el resumen de costos
    const costoDirectoElement = document.querySelector(`#costo-directo-${productoId}`);
    if (costoDirectoElement) {
        costoDirectoElement.textContent = `Costo Directo: ${sumaTotal.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
}

    // Llamada para actualizar todos los resúmenes de costos cuando se modifiquen los items
    function actualizarResumenDeCostos(productoId) {
        const productoElement = document.getElementById(`producto-${productoId}`);
        if (productoElement) {
            // Obtén los datos necesarios para el cálculo
            const costoDirecto = calcularCostoDirecto(productoId);
            const costoUnitario = calcularCostoUnitario(productoId);
            const administracion = calcularAdministracion(productoId);
            const imprevistos = calcularImprevistos(productoId);
            const utilidad = calcularUtilidad(productoId);
            const ofertaAntesIVA = calcularOfertaAntesIVA(productoId);
            const iva = calcularIVA(productoId);
            const valorOferta = calcularValorOferta(productoId);
    
            // Actualiza el resumen de costos
            const resumenCostos = document.querySelector(`#resumen-costos-${productoId}`);
            if (resumenCostos) {
                resumenCostos.querySelector(`#costo-directo-${productoId}`).textContent = `Costo Directo: ${costoDirecto}`;
                resumenCostos.querySelector(`#costo-unitario-${productoId}`).textContent = `Costo Directo Unitario: ${costoUnitario}`;
                resumenCostos.querySelector(`#administracion-${productoId}`).textContent = `Administración: ${administracion}`;
                resumenCostos.querySelector(`#imprevistos-${productoId}`).textContent = `Imprevistos: ${imprevistos}`;
                resumenCostos.querySelector(`#utilidad-${productoId}`).textContent = `Utilidad: ${utilidad}`;
                resumenCostos.querySelector(`#oferta-antes-iva-${productoId}`).textContent = `Oferta Antes De IVA: ${ofertaAntesIVA}`;
                resumenCostos.querySelector(`#iva-${productoId}`).textContent = `IVA: ${iva}`;
                resumenCostos.querySelector(`#valor-oferta-${productoId}`).textContent = `Valor Oferta Impuestos Incluidos: ${valorOferta}`;
            }
        }
    }
    
    
           
        function calcularPorcentaje(valor, porcentaje) {
            return (valor * porcentaje) / 100;
        }
        
        function actualizarTotalesExtras(itemNumber, costoDirecto, nuevoValorUtilidad = null, cantidadUnidades, index) {
            const productoElement = document.querySelector(`#producto-${itemNumber}`);
            if (productoElement) {
                const administracionPorcentaje = parseFloat(productoElement.dataset.administracion);
                const imprevistosPorcentaje = parseFloat(productoElement.dataset.imprevistos);
                const utilidadPorcentaje = nuevoValorUtilidad !== null ? nuevoValorUtilidad : parseFloat(productoElement.dataset.utilidad);
            
                const administracion = calcularPorcentaje(costoDirecto, administracionPorcentaje);
                const imprevistos = calcularPorcentaje(costoDirecto, imprevistosPorcentaje);
                const utilidad = calcularPorcentaje(costoDirecto, utilidadPorcentaje);
            
                const ofertaAntesIva = costoDirecto + administracion + imprevistos + utilidad;
                const iva = calcularPorcentaje(ofertaAntesIva, 19);
                const valorOferta = ofertaAntesIva + iva;
                const costoUnitario = costoDirecto / cantidadUnidades;
            
                // Actualiza el título del resumen de costos
                const resumenTitulo = document.getElementById(`titulo-resumen-${itemNumber}-${index}`);
                if (resumenTitulo) {
                    resumenTitulo.textContent = `Resumen de costos (${cantidadUnidades})`;
                } 
            
                document.getElementById(`costo-directo-${itemNumber}-${index}`).textContent = `Costo Directo: ${formatearNumero(costoDirecto)}`;
                document.getElementById(`costo-unitario-${itemNumber}-${index}`).textContent = `Costo Directo Unitario: ${formatearNumero(costoUnitario)}`;
                document.getElementById(`administracion-${itemNumber}-${index}`).innerHTML = `Administración: ${formatearNumero(administracion)} <span id="porcentaje-administracion-${itemNumber}-${index}">(${administracionPorcentaje}%)</span>`;
                document.getElementById(`imprevistos-${itemNumber}-${index}`).innerHTML = `Imprevistos: ${formatearNumero(imprevistos)} <span id="porcentaje-imprevistos-${itemNumber}-${index}">(${imprevistosPorcentaje}%)</span>`;
                document.getElementById(`utilidad-${itemNumber}-${index}`).innerHTML = `Utilidad: ${formatearNumero(utilidad)} <span id="porcentaje-utilidad-${itemNumber}-${index}">(${utilidadPorcentaje}%)</span>`;
                document.getElementById(`oferta-antes-iva-${itemNumber}-${index}`).textContent = `Oferta Antes De IVA: ${formatearNumero(ofertaAntesIva)}`;
                document.getElementById(`iva-${itemNumber}-${index}`).textContent = `IVA: ${formatearNumero(iva)}`;
                document.getElementById(`valor-oferta-${itemNumber}-${index}`).textContent = `Valor Oferta Impuestos Incluidos: ${formatearNumero(valorOferta)}`;
            } else {
                console.error('Error: Elemento del producto no encontrado');
            }
        }
        
        
        function formatearNumero(numero) {
            return numero.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }


        
    function mostrarNotificacion(mensaje, tipo) {
        const notificacion = document.createElement('div');
        notificacion.className = `notificacion ${tipo}`;
        notificacion.textContent = mensaje;
        document.body.appendChild(notificacion);
        setTimeout(() => {
            notificacion.remove();
        }, 3000);
    }
    
    

    function eliminarItemSeleccionado(button) {
        const fila = button.closest('tr');
        const itemNumber = fila.closest('tbody').id.split('-')[1];
        fila.remove();
        actualizarTotalProducto(itemNumber); // Actualizar el total del producto después de eliminar el ítem
    }

    function eliminarItemTemporal(button, itemId, itemNumber) {
        // Encuentra la fila del ítem temporal que se va a eliminar
        const fila = button.closest('tr');
        if (fila) {
            // Elimina la fila del contenedor de ítems temporales
            fila.remove();
            // Actualiza el total del producto después de eliminar el ítem
            actualizarTotalProducto(itemNumber);
        } else {
            console.error('Error: Fila no encontrada');
        }
    }
    
    

    let isLoading = false;

    function verTodosItems(itemNumber, pagina, busqueda) {
        if (isLoading) return; // Evitar que se realicen búsquedas adicionales mientras se está cargando
        
        isLoading = true;
        
        const seleccionItemsContainer = document.getElementById(`seleccion-items-${itemNumber}`);
        const paginacionContainer = document.getElementById(`paginacion-items-${itemNumber}`);
        const buscador = document.getElementById(`buscar-item-${itemNumber}`);
        
        // Mostrar animación de carga
        seleccionItemsContainer.innerHTML = '<div class="loading">Cargando...</div>';
        seleccionItemsContainer.classList.add('loading-active'); // Añadir clase de carga
        
        fetch(`/todos_los_items?pagina=${pagina}&busqueda=${busqueda}`)
            .then(response => response.json())
            .then(data => {
                const items = data.items;
                const totalPaginas = data.totalPaginas;
        
                // Usar setTimeout para retraso artificial
                setTimeout(() => {
                    // Limpiar animación de carga
                    seleccionItemsContainer.innerHTML = '';
                    seleccionItemsContainer.classList.remove('loading-active'); // Quitar clase de carga
                    
                    // Mostrar resultados
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Seleccionar</th>
                                <th>Grupo</th>
                                <th>Descripción</th>
                                <th>Unidad</th>
                                <th>Precio</th>
                                <th class="oculto">Tipo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td><input type="checkbox" id="item-${item.id}-${itemNumber}" value="${item.id}"></td>
                                    <td>${item.categoria}</td>
                                    <td>${item.descripcion}</td>
                                    <td>${item.unidad}</td>
                                    <td>${item.precio !== null ? item.precio : 'SIN PRECIO'}</td>
                                    <td class="oculto">${item.tipo}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    seleccionItemsContainer.appendChild(table);
        
                    // Actualizar paginación
                    paginacionContainer.innerHTML = '';
                    const maxPagesToShow = 5;
                    const half = Math.floor(maxPagesToShow / 2);
                    let startPage = Math.max(1, pagina - half);
                    let endPage = Math.min(totalPaginas, pagina + half);
        
                    if (pagina - half < 1) {
                        endPage = Math.min(totalPaginas, endPage + (half - pagina + 1));
                    }
                    if (pagina + half > totalPaginas) {
                        startPage = Math.max(1, startPage - (pagina + half - totalPaginas));
                    }
        
                    if (pagina > 1) {
                        const firstButton = document.createElement('button');
                        firstButton.textContent = '<<';
                        firstButton.addEventListener('click', () => verTodosItems(itemNumber, 1, busqueda));
                        paginacionContainer.appendChild(firstButton);
        
                        const prevButton = document.createElement('button');
                        prevButton.textContent = '<';
                        prevButton.addEventListener('click', () => verTodosItems(itemNumber, pagina - 1, busqueda));
                        paginacionContainer.appendChild(prevButton);
                    }
        
                    for (let i = startPage; i <= endPage; i++) {
                        const button = document.createElement('button');
                        button.textContent = i;
                        button.disabled = i === pagina;
                        button.addEventListener('click', () => verTodosItems(itemNumber, i, busqueda));
                        paginacionContainer.appendChild(button);
                    }
        
                    if (pagina < totalPaginas) {
                        const nextButton = document.createElement('button');
                        nextButton.textContent = '>';
                        nextButton.addEventListener('click', () => verTodosItems(itemNumber, pagina + 1, busqueda));
                        paginacionContainer.appendChild(nextButton);
        
                        const lastButton = document.createElement('button');
                        lastButton.textContent = '>>';
                        lastButton.addEventListener('click', () => verTodosItems(itemNumber, totalPaginas, busqueda));
                        paginacionContainer.appendChild(lastButton);
                    }
        
                    // Configurar el evento de búsqueda
                    buscador.addEventListener('input', debounce(() => {
                        const busqueda = buscador.value;
                        verTodosItems(itemNumber, 1, busqueda);
                    }, 300));
        
                    isLoading = false; // Rehabilitar búsqueda
                }, 1500); // Retraso de 2 segundos
            });
    }



    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('guardarCotizacionBtn').addEventListener('click', function() {
            // Capturar datos generales de la cotización
            const fecha = new Date();
            const fechaCotizacion = new Date().toISOString(); // Fecha y hora en formato ISO 8601
    
            // Captura otros datos
            const clienteCotizacion = document.getElementById('cliente_cotizacion').value.trim();
            const contactoCotizacion = document.getElementById('contacto_cotizacion').value.trim();
            const proyectoCotizacion = document.getElementById('proyecto_cotizacion').value.trim();
            const vendedorCotizacion = document.getElementById('vendedor_cotizacion').value.trim();
            const negociacion = document.getElementById('negociacion').value.trim();
            const formaPago = document.getElementById('forma_pago').value.trim();
            const validezCotizacion = document.getElementById('validez_cotizacion').value.trim();
            const descuentoCotizacion = document.getElementById('descuento_cotizacion').value.trim();
            const recibeCotizacion = document.getElementById('recibe_cotizacion').value.trim();
            const numeroContacto = document.getElementById('numero_contacto').value.trim();
            const direccionCotizacion = document.getElementById('direccion_cotizacion').value.trim();
            const ivaSeleccionado = document.getElementById('iva-select').value.trim();
    
            // Validar campos esenciales
            if (!clienteCotizacion || !contactoCotizacion || !proyectoCotizacion || !vendedorCotizacion || !negociacion) {
                alert("Por favor, complete todos los campos obligatorios: Cliente, Contacto, Proyecto, Vendedor y Negociación.");
                return;
            }
    

            

            // Capturar productos en la cotización
            const productos = [];
            const productoIdsCapturados = new Set();
    
            document.querySelectorAll('.producto').forEach(function(productoDiv) {
                const productoId = productoDiv.id.split('-')[1];
                if (productoIdsCapturados.has(productoId)) return;
                productoIdsCapturados.add(productoId);
    
                const productoSeleccionadoId = productoDiv.querySelector('input[name="producto_seleccionado_id"]').value;
                const descripcion = productoDiv.querySelector('h4').innerText;
                const medidasText = productoDiv.querySelector('h4:nth-of-type(2)').innerText;
                const medidasMatch = medidasText.match(/Alto \(Cm\): (\d+) \|\| Ancho \(Cm\): (\d+) \|\| Fondo \(Cm\): (\d+)/);
                const alto = medidasMatch ? parseFloat(medidasMatch[1]) : null;
                const ancho = medidasMatch ? parseFloat(medidasMatch[2]) : null;
                const fondo = medidasMatch ? parseFloat(medidasMatch[3]) : null;
    
                const cantidadesSeleccionadas = [];
                productoDiv.querySelectorAll('h4').forEach(function(cantidadH4) {
                    const cantidadText = cantidadH4.innerText;
                    const cantidadMatch = cantidadText.match(/Cantidad seleccionada \(\d+\): (\d+) unidades/);
                    if (cantidadMatch) {
                        cantidadesSeleccionadas.push(parseInt(cantidadMatch[1]));
                    }
                });
    
                const items = [];
                document.querySelectorAll('tbody tr').forEach(function(itemRow) {
                    const cantidadInput = itemRow.querySelector('input[type="number"]');
                    if (cantidadInput) {
                        const itemId = itemRow.querySelector('td:nth-child(1)').innerText.trim();
                        const itemCantidad = cantidadInput.value;
                        const itemTotalText = itemRow.querySelector('td.total').innerText.trim();
                
                        // Reemplazar separadores de miles y cambiar coma por punto decimal
                        const itemTotal = parseFloat(itemTotalText.replace(/\./g, '').replace(',', '.'));
                
                        items.push({
                            itemId: parseInt(itemId),
                            itemCantidad: parseInt(itemCantidad),
                            itemTotal: itemTotal
                        });
                    }
                });
    
                const resúmenesCostos = [];
                productoDiv.querySelectorAll('.resumen-costos-individual').forEach(function(resumenDiv, index) {
                    const costoDirectoElement = resumenDiv.querySelector(`#costo-directo-${productoId}-${index}`);
                    const administracionElement = resumenDiv.querySelector(`#administracion-${productoId}-${index}`);
                    const imprevistosElement = resumenDiv.querySelector(`#imprevistos-${productoId}-${index}`);
                    const utilidadElement = resumenDiv.querySelector(`#utilidad-${productoId}-${index}`);
                    const ofertaAntesIvaElement = resumenDiv.querySelector(`#oferta-antes-iva-${productoId}-${index}`);
                    const ivaElement = resumenDiv.querySelector(`#iva-${productoId}-${index}`);
                    const valorOfertaElement = resumenDiv.querySelector(`#valor-oferta-${productoId}-${index}`);
    
                    if (costoDirectoElement && administracionElement && imprevistosElement && utilidadElement &&
                        ofertaAntesIvaElement && ivaElement && valorOfertaElement) {
    
                        const costoDirecto = parseFloat(costoDirectoElement.innerText.split(': ')[1].replace(/\./g, '').replace(',', '.'));
                        const administracion = parseFloat(administracionElement.innerText.split(': ')[1].replace(/\./g, '').replace(',', '.'));
                        const imprevistos = parseFloat(imprevistosElement.innerText.split(': ')[1].replace(/\./g, '').replace(',', '.'));
                        const utilidad = parseFloat(utilidadElement.innerText.split(': ')[1].replace(/\./g, '').replace(',', '.'));
                        const ofertaAntesIva = parseFloat(ofertaAntesIvaElement.innerText.split(': ')[1].replace(/\./g, '').replace(',', '.'));
                        const iva = parseFloat(ivaElement.innerText.split(': ')[1].replace(/\./g, '').replace(',', '.'));
                        const valorOferta = parseFloat(valorOfertaElement.innerText.split(': ')[1].replace(/\./g, '').replace(',', '.'));
    
                        resúmenesCostos.push({
                            costoDirecto: costoDirecto,
                            administracion: administracion,
                            imprevistos: imprevistos,
                            utilidad: utilidad,
                            ofertaAntesIva: ofertaAntesIva,
                            iva: iva,
                            valorOferta: valorOferta
                        });
                    } else {
                        console.error(`Algunos elementos de resumen no se encontraron para el producto ${productoId} y resumen ${index}.`);
                    }
                });
    
                productos.push({
                    productoId: parseInt(productoId),
                    productoSeleccionadoId: parseInt(productoSeleccionadoId),
                    descripcion: descripcion.trim(),
                    alto: alto,
                    ancho: ancho,
                    fondo: fondo,
                    cantidadesSeleccionadas: cantidadesSeleccionadas,
                    items: items,
                    resúmenesCostos: resúmenesCostos
                });
            });
    
            const cotizacionData = {
                fechaCotizacion: fechaCotizacion,
                clienteCotizacion: clienteCotizacion,
                contactoCotizacion: contactoCotizacion,
                proyectoCotizacion: proyectoCotizacion,
                vendedorCotizacion: vendedorCotizacion,
                negociacion: negociacion,
                formaPago: formaPago,
                validezCotizacion: validezCotizacion,
                descuentoCotizacion: parseFloat(descuentoCotizacion),
                recibeCotizacion: recibeCotizacion,
                numeroContacto: numeroContacto,
                direccionCotizacion: direccionCotizacion,
                ivaSeleccionado: ivaSeleccionado,
                productos: productos
            };
    
            console.log('Datos a enviar:', cotizacionData);
    
            fetch('/guardar-cotizacion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cotizacionData),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Cotización guardada exitosamente:', data);
                if (data.success) {
                    alert('Cotización guardada con éxito.');
                } else {
                    alert('Error al guardar la cotización.');
                }
            })
            .catch(error => {
                console.error('Error al guardar la cotización:', error);
            });
        });
    });
    
    
        // Función para convertir el valor de texto a número
    function convertirValor(valorTexto) {
        // Elimina puntos (separadores de miles) y reemplaza la coma por punto (decimal)
        return parseFloat(valorTexto.replace(/\./g, '').replace(',', '.'));
    }
    

    
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
</script>
</html>